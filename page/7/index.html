<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="天空の城">
<meta property="og:url" content="http://www.njiang.cn/page/7/index.html">
<meta property="og:site_name" content="天空の城">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="天空の城">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.njiang.cn/page/7/"/>





  <title> 天空の城 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-43682645-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天空の城</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">愤怒的程序员，梦想着有一天也能飞！</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/31/iosxue-xi-bi-ji-core-data/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/31/iosxue-xi-bi-ji-core-data/" itemprop="url">
                  iOS学习笔记——Core Data
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-31T23:57:17+08:00">
              2014-07-31
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/31/iosxue-xi-bi-ji-core-data/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/31/iosxue-xi-bi-ji-core-data/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##7.1. 什么是Core Data</p>
<p>Core Data是一个Cocoa框架，用于为管理对象图提供基础实现，以及为多种文件格式的持久化提供支持。管理对象图包含的工作如撤销（undo）和重做（redo）、有效性检查、以及保证对象关系的完整性等。对象的持久化意味着Core Data可以将模型对象保存到持久化存储中，并在需要的时候将它们取出。Core Data应用程序的持久化存储（也就是对象数据的最终归档形式）的范围可以从XML文件到SQL数据库。Core Data用在关系数据库的前端应用程序是很理想的，但是所有的Cocoa应用程序都可以利用它的能力。</p>
<p>Core Data的核心概念是托管对象。托管对象是由Core Data管理的简单模型对象，但必须是NSManagedObject类或其子类的实例。可以用一个称为托管对象模型的结构（schema）来描述Core Data应用程序的托管对象（Xcode中包含一个数据建模工具，可以帮助您创建这些结构）。托管对象模型包含一些应用程序托管对象（也称为实体）的描述。每个描述负责指定一个实体的属性、它与其它实体的关系、以及像实体名称和实体表示类这样的元数据。</p>
<p>在一个运行着的Core Data程序中，有一个称为托管对象上下文的对象负责管理托管对象图。图中所有的托管对象都需要通过托管对象上下文来注册。该上下文对象允许在图中加入或删除对象，以及跟踪图中对象的变化，并因此可以提供撤销（undo）和重做（redo）的支持。当准备好保存对托管对象所做的修改时，托管对象上下文负责确保那些对象处于正确的状态。当Core Data应用程序希望从外部的数据存储中取出数据时，就向托管对象上下文发出一个取出请求，也就是一个指定一组条件的对象。在自动注册之后，上下文对象会从存储中返回与请求相匹配的对象。</p>
<p>托管对象上下文还作为访问潜在Core Data对象集合的网关，这个集合称为持久化堆栈。持久化堆栈处于应用程序对象和外部数据存储之间，由两种不同类型的对象组成，即持久化存储和持久化存储协调器对象。持久化存储位于栈的底部，负责外部存储（比如XML文件）的数据和托管对象上下文的相应对象之间的映射，但是它们不直接和托管对象上下文进行交互。在栈的持久化存储上面是持久化存储协调器，这种对象为一或多个托管对象上下文提供一个访问接口，使其下层的多个持久化存储可以表现为单一一个聚合存储。图7-1显示了Core Data架构中各种对象之间的关系。</p>
<img src="/uploads/2014-07-31/1.png" class="center" width="370" height="396"> 
<p>图7-1</p>
<p>Core Data中包含一个NSPersistentDocument类，它是NSDocument的子类，用与协助Core Data和文档架构之间的集成。持久化文档对象创建自己的持久化堆栈和托管对象上下文，将文档映射到一个外部的数据存储；NSPersistentDocument对象则为NSDocument中读写文档数据的方法提供缺省的实现。</p>
<p>通过Core Data管理应用程序的数据模型，可以极大程度减少需编写的代码数量。Core Data还具有下述特征：</p>
<ol>
<li>将对象数据存储在SQLite数据库以获得性能优化。</li>
<li>提供NSFetchedResultsController 类用于管理表视图的数据。即将Core Data的持久化存储显示在表视图中，并对这些数据进行管理：增、删，改。</li>
<li>管理undo/redo操作。</li>
<li>检查托管对象的属性值是否正确。</li>
</ol>
<p>###7.1.1. Core Data基本架构</p>
<p>在大多数应用中，需要打开一个文件，此文件包含一个有多个对象的归档，或者包含一个对至少一个根对象的引用。还需要能够归档所有对象到一个文件，并跟踪对象的变化。例如，在一个员工管理应用中，需要一种方法来打开一个文件，其中包含员工和部门对象的归档，并包含一个对至少一个根对象的引用——例如，含有全体员工的数组——如图7-2。还需要能够归档所有员工和所有部门到一个文件。</p>
<img src="/uploads/2014-07-31/2.png" class="center" width="456" height="455"> 
<p>图 7-2</p>
<p>使用的Core Data框架，大多数功能可以自动提供，这主要通过名为托管对象上下文（managed object context，或只是“上下文”，类NSManagedObjectContext的实例）来实现。托管对象的上下文就像一个网关，通过它可以访问底层的框架对象集合——这些对象集合统称为持久化堆栈（persistence stack）——它在应用程序和外部数据存储的对象之间提供访问通道。在堆栈的底部是持久化对象存储（persistent object stores），如图7-3所示。</p>
<img src="/uploads/2014-07-31/3.png" class="center" width="510" height="472"> 
<p>图7-3</p>
<p>Core Data不局限于基于文档的应用程序，也能创建基于Core Data的无用户界面的Utility应用。当然其他应用程序也能使用Core Data的。</p>
<p>####7.1.1.1. 托管对象和上下文(Managed Objects and Contexts)</p>
<p>可以把托管对象上下文作为一个智能便笺。当从持久化存储中获取对象时，这些对象的临时副本会在便笺上形成一个对象图（或者对象图的集合。对象图即对象 + 对象之间的联系），然后便可以任意修改这些对象。除非保存这些修改，否则持久化存储是不会受影响的。</p>
<p>Core Data框架中的模型对象（Model Objects，它是一种含有应用程序数据的对象类型，提供对数据的访问并实现逻辑来处理数据）称为托管对象。所有托管对象都必须通过托管对象上下文进行注册。该上下文对象允许在图中加入或删除对象，以及跟踪图中对象的变化，并因此可以提供撤销（undo）和重做（redo）的支持。当准备好保存对托管对象所做的修改时，托管对象上下文负责确保那些对象处于正确的状态。</p>
<p>如果要保存所做的更改，上下文首先要验证对象是有效的。如果对象有效，所作的更改会被写到持久化存储中，创建对象会添加新记录，删除对象则会删除记录。</p>
<p>可以在应用程序中使用多个上下文。对于持久化存储中的每一个对象，只有唯一的一个托管对象和给定的上下文相关联。从不同的角度考虑，持久化存储中的一个给定的对象，可在多个上下文中同时被编辑。然而，每个上下文都有它自己的对应着源对象的托管对象，每个托管对象都单独编辑。这样保存时就会导致数据不一致。Core Data提供了一些方法来处理这个问题，比如使用- (void)refreshObject:(NSManagedObject *)object mergeChanges: (BOOL)flag方法从持久化存储中获取最新的值来更新托管对象的持久化属性。</p>
<p>####7.1.1.2.获取数据请求（Fetch Requests）</p>
<p>使用托管对象上下文来检索数据时，会创建一个获取请求（fetch request，类NSFetchRequest的实例）的所有员工，按照工资最高到最低排序”。获取请求由三部分组成。最简单的获取请求必须指定一个实体的名称（这就暗示每次只能取一种实体类型）。获取请求也可能包含一个谓词对象，指定对象必须符合的条件（比如“市场部的所有员工”）。获取请求还包含一个排序描述方式对象的数组，指定对象应该出现的顺序（比如“按照工资最高到最低排序”），如图7-4所示。</p>
<img src="/uploads/2014-07-31/4.png" class="center" width="487" height="285"> 
<p>图 7-4</p>
<p>发送获取请求给托管对象上下文，它从与持久化存储相关联的数据源中返回的匹配请求的对象（也可能没有返回）。由于所有托管对象必须在托管对象上下文中注册，从获取请求返回的对象自动注册在用来获取的上下文中。上面说到，对于持久化存储中的每一个对象，只有唯一的一个托管对象和给定的上下文相关联。如果上下文中已经包含了一个托管对象作为获取请求返回的对象，那么这个托管对象则作为获取请求结果返回。</p>
<p>Core Data框架试图尽可能的高效。Core Data是需求驱动的，因此它只会创建实际需要的对象，不会额外创建更多对象。对象图并不代表持久化存储中的所有对象。仅指定一个持久化存储并不会把任何数据对象注册到托管对象上下文中。当从持久化存储中获取对象的一个​​子集，只能得到请求的对象。如果不再需要一个对象，默认情况下它会被释放。（这当然与从对象图中删除对象不一样。）</p>
<p>####7.1.1.3.持久化存储协调器</p>
<p>如上所述，在应用程序和外部数据存储的对象之间提供访问通道的框架对象集合统称为持久化堆栈（persistence stack）。在堆栈顶部的是托管对象上下文下，在堆栈底部的是持久化对象存储（persistent object stores）。在托管对象上下文和持久化对象存储之间便是持久化存储协调器（persistent store coordinator）。应用程序通过类NSPersistentStoreCoordinator的实例访问持久化对象存储。</p>
<p>持久化存储协调器为一或多个托管对象上下文提供一个访问接口，使其下层的多个持久化存储可以表现为单一一个聚合存储。一个托管对象上下文可以基于持久化存储协调器下的所有数据存储来创建一个对象图。持久化存储协调器只能与一个托管对象模型相关联。如果想把不同的实体放到不同存储中，必须依据托管对象模型中定义的配置把模型实体分区（partition）。</p>
<p>图7-5显示了一个例子，把员工和部门存储在一个文件中，并把客户和公司存储在另一个文件中。当获取对象时，他们会自动从相应的文件中返回；当保存更改时，会自动归档到相应的文件。</p>
<img src="/uploads/2014-07-31/5.png" class="center" width="370" height="396"> 
<p>图 7-5</p>
<p>####7.1.1.4.持久化存储（Persistent Stores）</p>
<p>一个特定的持久化对象存储是与单个文件或其他外部数​​据存储相关联的，负责存储中的数据和托管对象上下文中的对象之间的映射。通常情况下，读者与持久化对象存储之间只有一个交互，就是在应用程序中为一个新的外部数据存储指定位置（例如，当用户打开或保存文档）。Core Data的大多数交互则通过托管对象上下文实现。</p>
<p>应用程序代码中——特别是应用程序中托管对象的相关逻辑——不应该为持久化存储中的数据存储作出任何假设（即由Core Data自行处理）。Core Data为几种文件格式提供原生支持，选择使用哪一个取决于应用程序的需求。应用程序体系架构保持不变，也应该能在应用程序的某个阶段，选择一个不同的文件格式。此外，如果应用程序经过适当的抽象，那么不增加任何操作，就能够利用框架的后续增强功能。例如——即使在刚开始时，只能从本地文件系统获取数据——如果一个应用程序没有假设从哪里获取数据，同时后面的某个阶段又想为一种新的远程持久化存储类型添加支持，它也应该能够使用这种新类型而不用修改代码。</p>
<p>知识点</p>
<p>尽管Core Data虽然支持的SQLite作为其持久化存储类型之一，Core Data也无法管理任意的SQLite数据库。要使用SQLite数据库，Core Data必须自行创建和管理数据库。</p>
<p>####7.1.1.5.持久化文件（Persistent Documents）</p>
<p>可以通过程序创建和配置持久化堆栈。然而，在许多情况下，只是想创建一个基于文档的应用程序来读写文件。使用类NSDocument的子类NSPersistentDocument，便可轻松的利用Core Data完成此事。默认情况下，NSPersistentDocument实例便已经创建了自己的即用型持久化堆栈，包括一个托管对象上下文，和单个持久化对象存储。在这种情况下，有文档和外部数据存储之间便建立起一个“一对一”映射。</p>
<p>NSPersistentDocument类提供了方法来访问文档的托管对象上下文，并提供NSDocument方法的标准实现来读写文件，这些操作都是在Core Data框架内进行的。默认情况下，不必编写任何额外的代码来处理对象的持久化。一个持久化文档的撤消（undo）功能也被集成在托管对象上下文。</p>
<p>###7.1.2.托管对象（Managed Objects）和托管对象模型（Managed Object Model）</p>
<p>为了既管理的对象图，也支持对象持久化，Core Data需要对它操作的对象进行详尽的描述。托管对象模型（managed object model）是一个结构（schema），用来描述应用程序中的托管对象，或实体，如图7-6所示。通常使用Xcode的数据模型设计工具来创建托管对象模型。（也可以在运行时使用代码来建模。）它是类NSManagedObjectModel的一个实例。</p>
<img src="/uploads/2014-07-31/6.png" class="center" width="368" height="136"> 
<p>图 7-6</p>
<p>该模型由一个实体描述对象（类NSEntityDescription实例）的集合组成，每个对象提供一个实体的元数据（metadata），包括实体名，实体在应用程序中的类名（类名不必要与实体名称一样），实体的属性和实体之间关系。实体的属性和关系依次由属性和关系描述对象表示出来，如图7-7所示。</p>
<img src="/uploads/2014-07-31/7.png" class="center" width="442" height="352">  
<p>图 7-7</p>
<p>托管对象必须是NSManagedObject或者NSManagedObject子类的任一实例。NSManagedObject能够表述任何实体。它使用一个私有的内部存储，以维护其属性，并实现托管对象所需的所有基本行为。托管对象有一个指向实体描述的引用。实体描述表述了实体的元数据，包括实体的名称，实体的属性和实体之间的关系。可以创建NSManagedObject子类来实现实体的其他行为。</p>
<p>###7.1.3.基本实现</p>
<ol>
<li>指定存储数据文件</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span> *paths = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>);</div><div class="line"><span class="built_in">NSString</span> *documentsDirectory = [paths lastObject];</div><div class="line"><span class="built_in">NSString</span> *persistentStorePath = [[documentsDirectory stringByAppendingPathComponent:<span class="string">@"TopSongs.sqlite"</span>] <span class="keyword">retain</span>];</div></pre></td></tr></table></figure>
<ol>
<li>创建托管对象模型</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSManagedObjectModel</span>  *managedObjectModel = [[<span class="built_in">NSManagedObjectModel</span> mergedModelFromBundles:<span class="literal">nil</span>] <span class="keyword">retain</span>];</div></pre></td></tr></table></figure>
<ol>
<li>创建持久化存储协调器，并使用SQLite数据库做持久化存储</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *storeUrl = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="keyword">self</span>.persistentStorePath];</div><div class="line"><span class="built_in">NSPersistentStoreCoordinator</span> *persistentStoreCoordinator = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:<span class="keyword">self</span>.managedObjectModel];</div><div class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSPersistentStore</span> *persistentStore = [persistentStoreCoordinator addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeUrl options:<span class="literal">nil</span> error:&amp;amp;error];</div></pre></td></tr></table></figure>
<ol>
<li>创建托管对象上下文</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> <span class="built_in">NSManagedObjectContext</span> *managedObjectContext = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</div><div class="line">[managedObjectContext setPersistentStoreCoordinator: <span class="keyword">self</span>.persistentStoreCoordinator];</div></pre></td></tr></table></figure>
<ol>
<li>创建实体描述对象</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSEntityDescription</span> *entityDescription = [[<span class="built_in">NSEntityDescription</span> entityForName:<span class="string">@"Song"</span> inManagedObjectContext: <span class="keyword">self</span>.managedObjectContext] <span class="keyword">retain</span>];</div></pre></td></tr></table></figure>
<ol>
<li>创建托管对象</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSManagedObject</span> *managedObject = [[<span class="built_in">NSManagedObject</span> alloc] initWithEntity:<span class="keyword">self</span>.entityDescription insertIntoManagedObjectContext:<span class="keyword">self</span>.managedObjectContext];</div></pre></td></tr></table></figure>
<ol>
<li>保存</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> <span class="built_in">NSError</span> *saveError = <span class="literal">nil</span>;</div><div class="line">[<span class="keyword">self</span>.managedObjectContext save:&amp;amp;saveError]</div></pre></td></tr></table></figure>
<ol>
<li>创建获取数据请求</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="built_in">NSFetchRequest</span> *fetchRequest = [[<span class="built_in">NSFetchRequest</span> alloc] init];</div><div class="line"><span class="comment">// 数据排序，Sort key为NSManagedObject托管对象的一个属性</span></div><div class="line"><span class="built_in">NSSortDescriptor</span> *sortDescriptor = [[<span class="built_in">NSSortDescriptor</span> alloc] initWithKey:<span class="string">@""</span> ascending:<span class="literal">YES</span>];</div><div class="line"><span class="built_in">NSArray</span> *sortDescriptors = [[<span class="built_in">NSArray</span> alloc] initWithObjects:sortDescriptor, <span class="literal">nil</span>];</div><div class="line">[fetchRequest setSortDescriptors:sortDescriptors];</div></pre></td></tr></table></figure>
<ol>
<li>获取持久化存储中的数据，并对数据进行缓存</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="built_in">NSFetchedResultsController</span> *fetchedResultsController = [[<span class="built_in">NSFetchedResultsController</span> alloc]</div><div class="line">        initWithFetchRequest:<span class="keyword">self</span>.fetchRequest</div><div class="line">        managedObjectContext:<span class="keyword">self</span>.managedObjectContext</div><div class="line">        sectionNameKeyPath:<span class="literal">nil</span></div><div class="line">        cacheName:<span class="string">@""</span>];</div><div class="line"> </div><div class="line"><span class="built_in">NSError</span> *error;</div><div class="line"><span class="built_in">BOOL</span> success = [<span class="keyword">self</span>.fetchedResultsController performFetch:&amp;amp;error];</div></pre></td></tr></table></figure>
<ol>
<li>将数据显示在UITableView中</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView &#123;</div><div class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span>.fetchedResultsController sections] count];</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)table numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section &#123;</div><div class="line">    <span class="keyword">id</span>  sectionInfo = [[<span class="keyword">self</span>.fetchedResultsController sections] objectAtIndex:section];</div><div class="line">    <span class="keyword">return</span> [sectionInfo numberOfObjects];</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</div><div class="line">    <span class="built_in">UITableViewCell</span> *cell = ;</div><div class="line">    <span class="built_in">NSManagedObject</span> *managedObject = [<span class="keyword">self</span>.fetchedResultsController objectAtIndexPath:indexPath];</div><div class="line">    <span class="comment">// Configure the cell with data from the managed object.</span></div><div class="line">    <span class="keyword">return</span> cell;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">- (<span class="built_in">NSString</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView titleForHeaderInSection:(<span class="built_in">NSInteger</span>)section &#123;</div><div class="line">    <span class="keyword">id</span>  sectionInfo = [[<span class="keyword">self</span>.fetchedResultsController sections] objectAtIndex:section];</div><div class="line">    <span class="keyword">return</span> [sectionInfo name];</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">NSArray</span> *)sectionIndexTitlesForTableView:(<span class="built_in">UITableView</span> *)tableView &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.fetchedResultsController sectionIndexTitles];</div><div class="line">&#125;</div><div class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView sectionForSectionIndexTitle:(<span class="built_in">NSString</span> *)title atIndex:(<span class="built_in">NSInteger</span>)index &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.fetchedResultsController sectionForSectionIndexTitle:title atIndex:index];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>转自:<a href="http://hxsdit.com/1622" target="_blank" rel="external">http://hxsdit.com/1622</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/22/core-foundationyu-foundationde-qu-bie/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/22/core-foundationyu-foundationde-qu-bie/" itemprop="url">
                  Core Foundation与Foundation的区别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-22T20:03:39+08:00">
              2014-07-22
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/22/core-foundationyu-foundationde-qu-bie/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/22/core-foundationyu-foundationde-qu-bie/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Core Foundation框架 (CoreFoundation.framework) 是一组C语言接口，它们为iOS应用程序提供基本数据管理和服务功能。下面列举该框架支持进行管理的数据以及可提供的服务：</p>
<ul>
<li>群体数据类型 (数组、集合等)</li>
<li>程序包</li>
<li>字符串管理</li>
<li>日期和时间管理</li>
<li>原始数据块管理</li>
<li>偏好管理</li>
<li>URL及数据流操作</li>
<li>线程和RunLoop</li>
<li>端口和soket通讯</li>
</ul>
<p>Core Foundation框架和Foundation框架紧密相关，它们为相同功能提供接口，但Foundation框架提供Objective-C接口。如果您将Foundation对象和Core Foundation类型掺杂使用，则可利用两个框架之间的 “toll-free bridging”。所谓的Toll-free bridging是说您可以在某个框架的方法或函数同时使用Core Foundatio和Foundation框架中的某些类型。很多数据类型支持这一特性，其中包括群体和字符串数据类型。每个框架的类和类型描述都会对某个对象是否为 toll-free bridged，应和什么对象桥接进行说明。</p>
<p>###Objective-C指针与CoreFoundation指针之间的转换</p>
<p>ARC仅管理Objective-C指针（retain、release、autorelease），不管理CoreFoundation指针，CF指针由人工管理，手动的CFRetain和CFRelease来管理，注，CF中没有autorelease。</p>
<p>CocoaFoundation指针与CoreFoundation指针转换，需要考虑的是所指向对象所有权的归属。ARC提供了3个修饰符来管理。</p>
<ol>
<li><p>__bridge，什么也不做，仅仅是转换。此种情况下：</p>
<p> i). 从Cocoa转换到Core，需要人工CFRetain，否则，Cocoa指针释放后， 传出去的指针则无效。</p>
<p> ii). 从Core转换到Cocoa，需要人工CFRelease，否则，Cocoa指针释放后，对象引用计数仍为1，不会被销毁。</p>
</li>
<li><p>__bridge_retained，转换后自动调用<code>CFRetain</code>，即帮助自动解决上述i的情形。</p>
</li>
<li><p>__bridge_transfer，转换后自动调用<code>CFRelease</code>，即帮助自动解决上述ii的情形。</p>
</li>
</ol>
<p>由于ARC不能管理Core Foundation Object的生命周期，所以在Core Foundation和ARC之间，我们需要使用到<code>__bridge</code>,<code>__bridge_retained</code>和<code>__bridge_transfer</code>三个转换关键字。</p>
<p>根据苹果官方的文档</p>
<p><a href="https://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html" target="_blank" rel="external">https://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html</a></p>
<p><code>__bridge</code>只做类型转换，但是不修改对象（内存）管理权；</p>
<p><code>__bridge_retained</code>（也可以使用<code>CFBridgingRetain</code>）将Objective-C的对象转换为Core Foundation的对象，同时将对象（内存）的管理权交给我们，后续需要使用CFRelease或者相关方法来释放对象；</p>
<p><code>__bridge_transfer</code>（也可以使用CFBridgingRelease）将Core Foundation的对象转换为Objective-C的对象，同时将对象（内存）的管理权交给ARC。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/21/nsthread-,-nsrunloop-he-dispatch-queue/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/21/nsthread-,-nsrunloop-he-dispatch-queue/" itemprop="url">
                  NSThread 、NSRunLoop 和 Dispatch Queue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-21T21:21:23+08:00">
              2014-07-21
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/21/nsthread-,-nsrunloop-he-dispatch-queue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/21/nsthread-,-nsrunloop-he-dispatch-queue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>iOS多线程编程中，<code>NSOperation</code>和<code>NSOperationQueue</code>无疑是最常用的，它们能满足绝大部分情况下的线程操作。但在完成一些特殊的任务时，我们还是要使用的NSThread和NSRunLoop。</p>
<p><code>NSThread</code>很好理解，它等同于Java中的Thread类。<code>NSRunLoop</code>却不太好理解。从字面上说，RunLoop可以翻译成“运行回路”或“运行循环”，我们可以把它看成是一种特殊的循环结构——我们知道for或者while循环语句，其实NSRunLoop就是一种类似的循环，只不过它比for/while要复杂得多。我相信你已经看过苹果的《多线程编程指南》，其中“Run Loops”有专门的介绍。但这篇文档太长了，我相信你很难把它从头到尾都看完。本文会以实例的方式演示RunnLoop的使用，没有过于复杂的内容，保证你能看懂——有时候恰恰是我们自己把事情搞复杂了。</p>
<p>#一、当前RunLoop</p>
<p>当前RunLoop是指用 CFRunLoopGetCurrent 函数获取的RunLoop，它是运行在当前线程的RunLoop，在没有使用子线程的情况下，当前线程也可能是应用程序的主线程。如果你直接在主线程的方法里使用 CFRunLoopGetCurrent 函数，那么得到的RunLoop就是主线程的RunLoop。</p>
<p>新建Single View Application。在ViewController.xib中拖入一个按钮和一个TextView。并将两个对象都连接到源代码。</p>
<p>实现按钮的Action如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">IBAction</span>)RunOrStop:(<span class="keyword">id</span>)sender </div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="string">@"Run"</span>isEqualToString:btRun.titleLabel.text]) &#123;</div><div class="line">		tvList.text=<span class="literal">nil</span>;</div><div class="line">		[btRunsetTitle:<span class="string">@"Stop"</span>forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">		<span class="built_in">CFRunLoopTimerRef</span> timer; </div><div class="line">	    <span class="built_in">CFRunLoopTimerContext</span> timer_context;</div><div class="line">	    bzero(&amp;timer_context, <span class="keyword">sizeof</span>(timer_context));</div><div class="line">	    timer_context.info = <span class="keyword">self</span>; </div><div class="line">	    timer = <span class="built_in">CFRunLoopTimerCreate</span>(<span class="literal">NULL</span>, <span class="built_in">CFAbsoluteTimeGetCurrent</span>(), <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, _timer, &amp;timer_context);</div><div class="line">	    mRunLoopRef=<span class="built_in">CFRunLoopGetCurrent</span>();</div><div class="line">	    <span class="built_in">CFRunLoopAddTimer</span>( mRunLoopRef, timer, kCFRunLoopCommonModes); </div><div class="line">	    <span class="built_in">CFRunLoopRun</span>();</div><div class="line"></div><div class="line"> &#125;<span class="keyword">else</span>&#123;</div><div class="line">	[btRunsetTitle:<span class="string">@"Run"</span>forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">	<span class="keyword">if</span> ( mRunLoopRef )</div><div class="line">		<span class="built_in">CFRunLoopStop</span>( mRunLoopRef );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按钮btRun是一个乒乓式的按钮，用户点击它时它的title会在Run和Stop之间切换。</p>
<p>RunLoop是一种有源循环，它由各种“输入源”进行驱动。类似地，for语句由循环变量进行驱动，当循环变量到达某个值，循环中止。RunLoop的输入源可以有许多类型，这里我们只使用了最普通的定时器 CFRunLoopTimerRef。构造定时器时，需要一个 CFRunLoopTimerContext作为初始化时的上下文。</p>
<p>这个上下文是个结构体（有5个成员），其中info成员是void*类型（即id类型），对于我们来说可以把一些有用的对象传递进去，比如说self——self相当有用，因为self便于我们在c函数中调用成员方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFRunLoopTimerContext</span> timer_context;</div><div class="line">bzero(&amp;timer_context, <span class="keyword">sizeof</span>(timer_context));</div><div class="line">timer_context.info = <span class="keyword">self</span>;</div></pre></td></tr></table></figure></p>
<p>其他4个结构体成员对于我们来说都没有意义。因此上面3句其实也可以写成：<br><code>CFRunLoopTimerContext timer_context={0, self, NULL, NULL, NULL};</code><br>接下来就是用这个上下文构造timer：<br><code>timer= CFRunLoopTimerCreate(NULL, CFAbsoluteTimeGetCurrent(), 2, 0, 0, _timer, &amp;timer_context);</code><br>除了NULL和0之外的几个参数分别是：定时器启动时间、间隔秒数、定时执行函数、上下文指针。</p>
<p>其他参数我们都明白了，除了定时执行函数_timer——我们呆会再讨论它。接下来：</p>
<p><code>mRunLoopRef=CFRunLoopGetCurrent();</code>一句获取当前线程的RunLoop；同时把RunLoop保存在<code>mRunLoopRef中。mRunLoopRef</code>需要声明为静态变量，这样较方便我们在c函数_timer中访问：</p>
<p><code>static CFRunLoopRef mRunLoopRef;</code></p>
<p>这一句将Timer添加到RunLoop：</p>
<p><code>CFRunLoopAddTimer( mRunLoopRef, timer, kCFRunLoopCommonModes);</code></p>
<p>这一句启动RunLoop：</p>
<p><code>CFRunLoopRun();</code></p>
<p>实现_timer()函数如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> _timer(<span class="built_in">CFRunLoopTimerRef</span> timer __unused, <span class="keyword">void</span> *info) </div><div class="line">&#123; </div><div class="line">    loops++;</div><div class="line">    <span class="keyword">id</span> obj=(<span class="keyword">id</span>)info;</div><div class="line">    [obj performSelectorOnMainThread:<span class="keyword">@selector</span>(updateTextView) withObject:nilwaitUntilDone:<span class="literal">NO</span>];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>_timer函数根据约定，为CFRunLoopTimerCallBack结构，因此它拥有两个参数：</p>
<p><code>CFRunLoopTimerRef timer, void *info</code></p>
<p>loops变量也声明为静态的（方便在c函数中调用），没有什么意义，我们仅仅是用来记录循环次数的。</p>
<p>info参数（实际上我们指定了一个self对象）在这里排上了用场，我们将会在这里调用self的updateTextView方法。因为updateTextView方法会对UI进行更新，根据UKit的规定，对UI进行刷新应当在主线程中进行，所以我们用performSelectorOnMainThread来强制在主线程执行updateView方法。</p>
<p>updateView方法实现如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>) updateTextView</div><div class="line">&#123;</div><div class="line">    tvList.text=[<span class="built_in">NSStringstringWithFormat</span>:<span class="string">@"%@\n%d"</span>,tvList.text,loops];</div><div class="line">    <span class="built_in">NSRange</span> range;</div><div class="line">    range = <span class="built_in">NSMakeRange</span> ([[tvListtext] length], <span class="number">0</span>);</div><div class="line">    [tvListscrollRangeToVisible:range];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行程序，当我们点击Run按钮，RunLoop循环会一遍一遍地去执行，同时TextView中会显示执行的循环次数。</p>
<p>等等，为什么会这样？</p>
<p>当你点击“Stop”按钮，发现RunLoop并不会停下来。相反，当你再次点击“Run”按钮之后，RunLoop似乎循环得更快了！基本上达到1秒钟执行一次。如果你反复点击“Stop/Run”按钮，循环会越来越快！</p>
<p>CFRunLoopStop 似乎并没有被执行。其实，getCurrentRunLoop拿到的是当前线程的RunLoop，对于现在的情况，实际上是主线程的RunLoop。你在主线程的RunLoop中添加了新的源，但你并没有权限停止它。而且，由于你多次点击Run按钮，RunLoop中被加入了多个Timer！这导致_timer函数在同一时间内被执行得更多。</p>
<p>要想停止RunLoop，你必需要创建自己的Thread，然后停止它的RunLoop。这样还可以带来另外一个好处：RunLoop不会阻塞主线程！仔细观察程序运行的结果，你会发现当Run按钮被按下时，按钮的状态始终是在Highlight状态，而不会恢复到Normal状态：</p>
<p>Stop按钮背景始终呈现Highlight的蓝色，是因为主线程被RunLoop阻塞了。除非RunLoop停止，按钮不会恢复为Normal状态。</p>
<p>那么，我们只有创建一个NSThread了。</p>
<p>#二、子线程中的RunLoop</p>
<p>每个线程中都自带RunLoop，用<code>CFRunLoopGetCurrent()</code>函数可以获得当前线程的RunLoop。如果RunLoop中没有任何源，RunLoop不会运行。我们可以为这个RunLoop添加新的源。</p>
<p>修改RunOrStop方法代码为：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">IBAction</span>)RunOrStop:(<span class="keyword">id</span>)sender </div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="string">@"Run"</span>isEqualToString:btRun.titleLabel.text]) &#123;</div><div class="line">        tvList.text=<span class="literal">nil</span>;</div><div class="line">        [btRunsetTitle:<span class="string">@"Stop"</span>forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">        <span class="built_in">NSThread</span> *thread = [[<span class="built_in">NSThreadalloc</span>] initWithTarget:selfselector:<span class="keyword">@selector</span>(aThread) object:<span class="literal">nil</span>]; </div><div class="line">       [thread start];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        [btRunsetTitle:<span class="string">@"Run"</span>forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">        <span class="keyword">if</span> ( mRunLoopRef )</div><div class="line">            <span class="built_in">CFRunLoopStop</span>( mRunLoopRef );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同时实现aThread方法如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)aThread</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CFRunLoopTimerRef</span> timer; </div><div class="line">	<span class="built_in">CFRunLoopTimerContext</span> timer_context=&#123;<span class="number">0</span>, <span class="keyword">self</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</div><div class="line">    timer = <span class="built_in">CFRunLoopTimerCreate</span>(<span class="literal">NULL</span>, <span class="built_in">CFAbsoluteTimeGetCurrent</span>(), <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, _timer, &amp;timer_context);</div><div class="line">    mRunLoopRef=<span class="built_in">CFRunLoopGetCurrent</span>();</div><div class="line">    <span class="built_in">CFRunLoopAddTimer</span>( mRunLoopRef, timer, kCFRunLoopCommonModes); </div><div class="line">    <span class="built_in">CFRunLoopRun</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，RunOrStop方法中，我们创建了新的 NSThread对象并启动了它。而原来的RunLoop代码被移到新的线程方法aThread中来了。</p>
<p>运行程序，你在RunLoop运行之后可以用Stop来停止它了。同时，主线程不会再被阻塞，Stop按钮点下后，经过短暂的Highlight状态即恢复到了Normal状态，Stop按钮终于不再是怪异的蓝色了.</p>
<p>#三、添加自定义源</p>
<p>我们还可以尝试定义自定义的输入源。这样，当timer源触发之后，我们还可以调用自定义源，干点别的事。触发另一个源，使用 函数 CFRunLoopSourceSignal ：</p>
<p><code>voidCFRunLoopSourceSignal(CFRunLoopSourceRef source);</code></p>
<p>在_timer函数中加入此句：</p>
<p><code>if(source) CFRunLoopSourceSignal(source);</code></p>
<p>参数source指定要触发的输入源。</p>
<p>我们修改aThread方法如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)aThread</div><div class="line">&#123;</div><div class="line">	<span class="built_in">CFRunLoopSourceContext</span> source_context;</div><div class="line">    bzero(&amp;source_context, <span class="keyword">sizeof</span>(source_context)); </div><div class="line">    source_context.perform = _perform; </div><div class="line">    source = <span class="built_in">CFRunLoopSourceCreate</span>(<span class="literal">NULL</span>, <span class="number">0</span>,&amp;source_context); </div><div class="line">    <span class="built_in">CFRunLoopAddSource</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), source, kCFRunLoopCommonModes);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，source被声明为静态变量：</p>
<p><code>staticCFRunLoopSourceRef source;</code></p>
<p>然后实现_perform函数：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> _perform(<span class="keyword">void</span> *info) </div><div class="line">&#123; </div><div class="line">	<span class="keyword">if</span> (loops%<span class="number">10</span>==<span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">CFRunLoopStop</span>(mRunLoopRef);</div><div class="line">        printf(<span class="string">"loops=%d,RunLoop is stopped.\n"</span>,loops); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后修改RunOrStop方法，注释以下语句，因为RunLoop的停止我们交给_perform函数来做了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//       [btRun setTitle:@&quot;Stop&quot; forState:UIControlStateNormal];</div><div class="line">//        [btRun setTitle:@&quot;Run&quot;forState:UIControlStateNormal];</div><div class="line">//        if ( mRunLoopRef )</div><div class="line">//          	CFRunLoopStop( mRunLoopRef );</div></pre></td></tr></table></figure></p>
<p>现在执行程序，RunLoop每运行10次就会自动停下来：</p>
<p>loops=10,Run Loop isstopped.</p>
<p>loops=20,Run Loop isstopped.</p>
<p>loops=30,Run Loop isstopped.</p>
<p>四、dispatch source</p>
<p>在iOS异步编程模型中，线程是最传统的解决方案。然而线程模型仍然有着一些为人所诟病的缺点：难于编写、可伸缩性不强。iOS通过dispathqueue和dispatch source来支持并行编程（参考苹果文档《 Concurrency Programming Guide 》）。上述代码也可以用并行并行编程方式来解决。</p>
<p>修改RunoOrStop:的代码为：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">IBAction</span>)RunOrStop:(<span class="keyword">id</span>)sender </div><div class="line">&#123;</div><div class="line">    source = dispatch_source_create(DISPATCH_SOURCE_TYPE_DATA_ADD, <span class="number">0</span>, <span class="number">0</span>, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>));</div><div class="line">	dispatch_source_set_event_handler(source, ^&#123; </div><div class="line">		<span class="keyword">if</span> (loops%<span class="number">10</span>==<span class="number">0</span>) &#123;</div><div class="line">			dispatch_source_cancel(source);</div><div class="line">			dispatch_release(source);</div><div class="line">			dispatch_source_cancel(timer);</div><div class="line">			dispatch_release(timer);</div><div class="line">			printf(<span class="string">"loops=%d,Dispatchsource is stopped.\n"</span>,loops); </div><div class="line">        &#125;</div><div class="line">    &#125;); </div><div class="line"></div><div class="line">    dispatch_resume(source);</div><div class="line">    timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)); </div><div class="line">    dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, <span class="number">1</span>ull * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);  </div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        loops++;</div><div class="line">        [selfperformSelectorOnMainThread:<span class="keyword">@selector</span>(updateTextView) withObject:nilwaitUntilDone:<span class="literal">NO</span>];</div><div class="line">        dispatch_source_merge_data(source, <span class="number">1</span>); </div><div class="line">    &#125;); </div><div class="line">    dispatch_resume(timer);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中timer和source声明为外部静态变量:</p>
<p><code>static dispatch_source_t source,timer;</code></p>
<p>运行程序。没有使用线程、没有RunLoop，但仍然实现了同样的效果。从中可以看出，dispatch queue并行编程拥有许多优点：不需要显式地创建线程和为线程分配栈空间、代码极大地简化、块语法支持。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/20/guan-yu-nsrunloophe-nstimerde-zhi-shi/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/20/guan-yu-nsrunloophe-nstimerde-zhi-shi/" itemprop="url">
                  关于NSRunLoop和NSTimer的知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-20T15:26:16+08:00">
              2014-07-20
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/20/guan-yu-nsrunloophe-nstimerde-zhi-shi/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/20/guan-yu-nsrunloophe-nstimerde-zhi-shi/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.什么是<code>NSRunLoop</code></p>
<p><code>NSRunLoop</code>是消息机制的处理模式</p>
<p><code>NSRunLoop</code>的作用在于有事情做的时候使的当前NSRunLoop的线程工作，没有事情做让当前<code>NSRunLoop</code>的线程休眠</p>
<p><code>NSTimer</code>默认添加到当前<code>NSRunLoop</code>中，也可以手动制定添加到自己新建的<code>NSRunLoop</code></p>
<p><code>NSRunLoop</code>就是一直在循环检测，从线程start到线程end，检测inputsource(如点击，双击等操作)同步事件，检测timesource同步事件，检测到输入源会执行处理函数，首先会产生通知，corefunction向线程添加runloop observers来监听事件，意在监听事件发生时来做处理。</p>
<p>在单线程的app中，不需要注意Run Loop，但不代表没有。程序启动时，系统已经在主线程中加入了Run Loop。它保证了我们的主线程在运行起来后，就处于一种“等待”的状态（而不像一些命令行程序一样运行一次就结束了），这个时候如果有接收到的事件（Timer的定时到了或是其他线程的消息），就会执行任务，否则就处于休眠状态。</p>
<p>runloopmode是一个集合，包括监听：事件源，定时器，以及需通知的runloop observers<br>模式包括：<br>default模式：几乎包括所有输入源(除NSConnection) <code>NSDefaultRunLoopMode</code>模式<br>mode模式：处理modal panels<br>connection模式：处理NSConnection事件，属于系统内部，用户基本不用<br>event tracking模式：如组件拖动输入源 UITrackingRunLoopModes 不处理定时事件<br>common modes模式：NSRunLoopCommonModes 这是一组可配置的通用模式。将input sources与该模式关联则同时也将input sources与该组中的其它模式进行了关联。 </p>
<p>每次运行一个run loop，你指定（显式或隐式）run loop的运行模式。当相应的模式传递给run loop时，只有与该模式对应的input sources才被监控并允许run loop对事件进行处理（与此类似，也只有与该模式对应的observers才会被通知）</p>
<p>例：<br>1).在timer与table同时执行情况，当拖动table时，runloop进入<code>UITrackingRunLoopModes</code>模式下，不会处理定时事件，此时timer不能处理，所以此时将timer加入到NSRunLoopCommonModes模式(addTimer forMode)<br>2).在scroll一个页面时来松开，此时connection不会收到消息，由于scroll时runloop为UITrackingRunLoopModes模式，不接收输入源，此时要修改connection的mode<br>[scheduleInRunLoop:[NSRunLoop currentRunLoop]forMode:NSRunLoopCommonModes];</p>
<p>关于<code>-(BOOL)runMode:(NSString *)mode beforeDate:(NSDate *)date;</code>方法<br>指定runloop模式来处理输入源，首个输入源或date结束退出。<br>暂停当前处理的流程，转而处理其他输入源，当date设置为<code>[NSDate distantFuture]</code>(将来，基本不会到达的时间)，所以除非处理其他输入源结束，否则永不退出处理暂停的当前处理的流程。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span>(A)&#123;</div><div class="line"> [[<span class="built_in">NSRunLoop</span> currentRunLoop] runMode:<span class="built_in">NSDefaultRunLoopMode</span> beforeDate:[<span class="built_in">NSDate</span> distantFuture]]; </div><div class="line">&#125;</div></pre></td></tr></table></figure><br>当前A为YES时，当前runloop会一直接收处理其他输入源，当前流程不继续处理，出为A为NO，当前流程继续</p>
<p>performSelector关于内存管理的执行原理是这样的执行 <code>[self performSelector:@selector(method1:) withObject:self.tableLayer afterDelay:3];</code>的时候，系统会将tableLayer的引用计数加1，执行完这个方法时，还会将tableLayer的引用计数减1，由于延迟这时tableLayer的引用计数没有减少到0，也就导致了切换场景dealloc方法没有被调用，出现了内存泄露。<br>利用如下函数：<br><code>[NSObject cancelPreviousPerformRequestsWithTarget:self]</code><br>当然你也可以一个一个得这样用：<br><code>[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(method1:) object:nil]</code><br>加上了这个以后，顺利地执行了dealloc方法</p>
<p>在touchBegan里面<br><code>[self performSelector:@selector(longPressMethod:) withObject:nil afterDelay:longPressTime]</code><br>然后在end 或cancel里做判断，如果时间不够长按的时间调用：<br><code>[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(longPressMethod:) object:nil]</code><br>取消began里的方法</p>
<p>2.Run Loop和线程的关系：</p>
<ol>
<li>主线程的run loop默认是启动的，用于接收各种输入sources</li>
<li>对第二线程来说，run loop默认是没有启动的，如果你需要更多的线程交互则可以手动配置和启动，如果线程执行一个长时间已确定的任务则不需要。</li>
</ol>
<p>3.Run Loop什么情况下使用：</p>
<p>a. 使用ports 或 input sources 和其他线程通信   // 不了解<br>b. 在线程中使用timers                                             // 如果不启动run loop，timer的事件是不会响应的<br>c. 在Cocoa 应用中使用performSelector…方法   // 应该是performSelector…这种方法会启动一个线程并启动run loop吧<br>d. 让线程执行一个周期性的任务      </p>
<p>注：timer的创建和释放必须在同一线程中。<br><code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</code>此方法会retain timer对象的引用计数。</p>
<p>关于NSTimer</p>
<p>1.NSTimer会是准时触发事件吗</p>
<p>答案是否定的，而且有时候你会发现实际的触发时间跟你想象的差距还比较大。NSTimer不是一个实时系统，因此不管是一次性的还是周期性的timer的实际触发事件的时间可能都会跟我们预想的会有出入。差距的大小跟当前我们程序的执行情况有关系，比如可能程序是多线程的，而你的timer只是添加在某一个线程的runloop的某一种指定的runloopmode中，由于多线程通常都是分时执行的，而且每次执行的mode也可能随着实际情况发生变化。</p>
<p>　　假设你添加了一个timer指定2秒后触发某一个事件，但是签好那个时候当前线程在执行一个连续运算(例如大数据块的处理等)，这个时候timer就会延迟到该连续运算执行完以后才会执行。重复性的timer遇到这种情况，如果延迟超过了一个周期，则会和后面的触发进行合并，即在一个周期内只会触发一次。但是不管该timer的触发时间延迟的有多离谱，他后面的timer的触发时间总是倍数于第一次添加timer的间隙。</p>
<p>　　原文如下</p>
<blockquote>
<p>“A repeating timer reschedules itself based on the scheduled firing time, not the actual firing time. For example, if a timer is scheduled to fire at a particular time and every 5 seconds after that, the scheduled firing time will always fall on the original 5 second time intervals, even if the actual firing time gets delayed. If the firing time is delayed so far that it passes one or more of the scheduled firing times, the timer is fired only once for that time period; the timer is then rescheduled, after firing, for the next scheduled firing time in the future.”</p>
</blockquote>
<p>　　下面请看一个简单的例子:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    SvTestObject *testObject2 = [[SvTestObject alloc] init];</div><div class="line">    [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1</span> target:testObject2 selector:<span class="keyword">@selector</span>(timerAction:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">    [testObject2 release];</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Simulate busy"</span>);</div><div class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(simulateBusy) withObject:<span class="literal">nil</span> afterDelay:<span class="number">3</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 模拟当前线程正好繁忙的情况</span></div><div class="line">- (<span class="keyword">void</span>)simulateBusy</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"start simulate busy!"</span>);</div><div class="line">    <span class="built_in">NSUInteger</span> caculateCount = <span class="number">0x0FFFFFFF</span>;</div><div class="line">    <span class="built_in">CGFloat</span> uselessValue = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; caculateCount; ++i) &#123;</div><div class="line">        uselessValue = i / <span class="number">0.3333</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"finish simulate busy!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>例子中首先开启了一个timer，这个timer每隔1秒调用一次target的timerAction方法，紧接着我们在3秒后调用了一个模拟线程繁忙的方法(其实就是一个大的循环)。运行程序后输出结果如下:</p>
<p>观察结果我们可以发现，当线程空闲的时候timer的消息触发还是比较准确的，但是在36分12秒开始线程一直忙着做大量运算，知道36分14秒该运算才结束，这个时候timer才触发消息，这个线程繁忙的过程超过了一个周期，但是timer并没有连着触发两次消息，而只是触发了一次。等线程忙完以后后面的消息触发的时间仍然都是整数倍与开始我们指定的时间，这也从侧面证明，timer并不会因为触发延迟而导致后面的触发时间发生延迟。</p>
<p>综上: timer不是一种实时的机制，会存在延迟，而且延迟的程度跟当前线程的执行情况有关。</p>
<p>2.NSTimer为什么要添加到RunLoop中才会有作用</p>
<p>前面的例子中我们使用的是一种便利方法，它其实是做了两件事：首先创建一个timer，然后将该timer添加到当前runloop的default mode中。也就是这个便利方法给我们造成了只要创建了timer就可以生效的错觉，我们当然可以自己创建timer，然后手动的把它添加到指定runloop的指定mode中去。</p>
<p>　　NSTimer其实也是一种资源，如果看过多线程变成指引文档的话，我们会发现所有的source如果要起作用，就得加到runloop中去。同理timer这种资源要想起作用，那肯定也需要加到runloop中才会又效喽。如果一个runloop里面不包含任何资源的话，运行该runloop时会立马退出。你可能会说那我们APP的主线程的runloop我们没有往其中添加任何资源，为什么它还好好的运行。我们不添加，不代表框架没有添加，如果有兴趣的话你可以打印一下main thread的runloop，你会发现有很多资源。 </p>
<p>　　下面我们看一个小例子：　　<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> testTimerWithOutShedule];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)testTimerWithOutShedule</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Test timer without shedult to runloop"</span>);</div><div class="line">    SvTestObject *testObject3 = [[SvTestObject alloc] init];</div><div class="line">    <span class="built_in">NSTimer</span> *timer = [[<span class="built_in">NSTimer</span> alloc] initWithFireDate:[<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="number">1</span>] interval:<span class="number">1</span> target:testObject3 selector:<span class="keyword">@selector</span>(timerAction:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</div><div class="line">    [testObject3 release];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"invoke release to testObject3"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)applicationWillResignActive:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"SvTimerSample Will resign Avtive!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个小例子中我们新建了一个timer，为它指定了有效的target和selector，并指出了1秒后触发该消息，运行结果如下:</p>
<p>观察发现这个消息永远也不会触发，原因很简单，我们没有将timer添加到runloop中。</p>
<p>综上: 必须得把timer添加到runloop中，它才会生效。</p>
<p>3.NSTimer加到了RunLoop中但迟迟的不触发事件</p>
<p>为什么明明添加了，但是就是不按照预先的逻辑触发事件呢？？？原因主要有以下两个:</p>
<p>1、runloop是否运行</p>
<p>　　每一个线程都有它自己的runloop，程序的主线程会自动的使runloop生效，但对于我们自己新建的线程，它的runloop是不会自己运行起来，当我们需要使用它的runloop时，就得自己启动。</p>
<p>　　那么如果我们把一个timer添加到了非主线的runloop中，它还会按照预期按时触发吗？下面请看一段测试程序:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(testTimerSheduleToRunloop1) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 测试把timer加到不运行的runloop上的情况</span></div><div class="line">- (<span class="keyword">void</span>)testTimerSheduleToRunloop1</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Test timer shedult to a non-running runloop"</span>);</div><div class="line">    SvTestObject *testObject4 = [[SvTestObject alloc] init];</div><div class="line">    <span class="built_in">NSTimer</span> *timer = [[<span class="built_in">NSTimer</span> alloc] initWithFireDate:[<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="number">1</span>] interval:<span class="number">1</span> target:testObject4 selector:<span class="keyword">@selector</span>(timerAction:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</div><div class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">    <span class="comment">// 打开下面一行输出runloop的内容就可以看出，timer却是已经被添加进去</span></div><div class="line">    <span class="comment">//NSLog(@"the thread's runloop: %@", [NSRunLoop currentRunLoop]);</span></div><div class="line">    </div><div class="line">    <span class="comment">// 打开下面一行, 该线程的runloop就会运行起来，timer才会起作用</span></div><div class="line">    <span class="comment">//[[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:3]];</span></div><div class="line">    </div><div class="line">    [testObject4 release];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"invoke release to testObject4"</span>);</div><div class="line"></div><div class="line">    [pool release];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)applicationWillResignActive:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"SvTimerSample Will resign Avtive!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的程序中，我们新创建了一个线程，然后创建一个timer，并把它添加当该线程的runloop当中，但是运行结果如下：</p>
<p>观察运行结果，我们发现这个timer知道执行退出也没有触发我们指定的方法，如果我们把上面测试程序中<code>[[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:3]];</code>这一行的注释去掉，则timer将会正确的掉用我们指定的方法。</p>
<p>2、mode是否正确</p>
<p>　　我们前面自己动手添加runloop的时候，可以看到有一个参数runloopMode，这个参数是干嘛的呢？</p>
<p>　　前面提到了要想timer生效，我们就得把它添加到指定runloop的指定mode中去，通常是主线程的defalut mode。但有时我们这样做了，却仍然发现timer还是没有触发事件。这是为什么呢？</p>
<p>　　这是因为timer添加的时候，我们需要指定一个mode，因为同一线程的runloop在运行的时候，任意时刻只能处于一种mode。所以只能当程序处于这种mode的时候，timer才能得到触发事件的机会。</p>
<p>　　举个不恰当的例子，我们说兄弟几个分别代表runloop的mode，timer代表他们自己的才水桶，然后一群人去排队打水，只有一个水龙头，那么同一时刻，肯定只能有一个人处于接水的状态。也就是说你虽然给了老二一个桶，但是还没轮到它，那么你就得等，只有轮到他的时候你的水桶才能碰上用场。</p>
<p>综上: 要让timer生效，必须保证该线程的runloop已启动，而且其运行的runloopmode也要匹配。</p>
<p>转自:<a href="http://blog.csdn.net/ioswyl88219/article/details/16996531" target="_blank" rel="external">http://blog.csdn.net/ioswyl88219/article/details/16996531</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/20/ios-multiple-thread/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/20/ios-multiple-thread/" itemprop="url">
                  iOS Multiple Thread
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-20T10:54:29+08:00">
              2014-07-20
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/20/ios-multiple-thread/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/20/ios-multiple-thread/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-使用POSIX创建多线程"><a href="#1-使用POSIX创建多线程" class="headerlink" title="1. 使用POSIX创建多线程"></a>1. 使用POSIX创建多线程</h1><p>(1). 创建出pthread_attr_t，并设置属性<br>(2). 调用pthread_create创建出线程，此时已经开始运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">void* PosixThreadMainRoutine(void* data)</div><div class="line">&#123;    </div><div class="line">    // Do some work here.    </div><div class="line">    return NULL;</div><div class="line">&#125;</div><div class="line">void LaunchThread()</div><div class="line">&#123;    </div><div class="line">    // Create the thread using POSIX routines.    </div><div class="line">    pthread_attr_t  attr;    </div><div class="line">    pthread_t       posixThreadID;    </div><div class="line">    int             returnVal;    </div><div class="line">    returnVal = pthread_attr_init(&amp;attr);    </div><div class="line">    assert(!returnVal);    </div><div class="line">    returnVal = pthread_attr_setdetachstate(&amp;attr, THREAD_CREATE_DETACHED);    assert(!returnVal);    </div><div class="line">    int     threadError = pthread_create(&amp;posixThreadID, &amp;attr, &amp;PosixThreadMainRoutine, NULL);    </div><div class="line">    returnVal = pthread_attr_destroy(&amp;attr);    </div><div class="line">    assert(!returnVal);    </div><div class="line">    if (threadError != 0)    </div><div class="line">    &#123;        </div><div class="line">        // Report an error.    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/12/given-a-linked-list-reverse-alternate-nodes-and-append-at-the-end/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/12/given-a-linked-list-reverse-alternate-nodes-and-append-at-the-end/" itemprop="url">
                  Given a linked list, reverse alternate nodes and append at the end
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-12T21:11:31+08:00">
              2014-07-12
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/12/given-a-linked-list-reverse-alternate-nodes-and-append-at-the-end/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/12/given-a-linked-list-reverse-alternate-nodes-and-append-at-the-end/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Given a linked list, reverse alternate nodes and append them to end of list. Extra allowed space is O(1)<br>Examples</p>
<p>Input List:  1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;6<br>Output List: 1-&gt;3-&gt;5-&gt;6-&gt;4-&gt;2</p>
<p>Input List:  12-&gt;14-&gt;16-&gt;18-&gt;20<br>Output List: 12-&gt;16-&gt;20-&gt;18-&gt;14<br>We strongly recommend to minimize the browser and try this yourself first.</p>
<p>The idea is to maintain two linked lists, one list of all odd positioned nodes (1, 3, 5 in above example) and other list of all even positioned nodes (6, 4 and 2 in above example). Following are detailed steps.<br>1) Traverse the given linked list which is considered as odd list. Do following for every visited node.<br>……a) If the node is even node, remove it from odd list and add it to the front of even node list. Nodes are added at front to keep the reverse order.<br>2) Append the even node list at the end of odd node list.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// C++ program to find maximum path sum between two leaves of</span></div><div class="line"><span class="comment">// a binary tree</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="comment">// A binary tree node</span></div><div class="line"><span class="keyword">struct</span> Node</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="keyword">struct</span> Node* left, *right;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Utility function to allocate memory for a new node</span></div><div class="line"><span class="function"><span class="keyword">struct</span> Node* <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> data)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> Node* node = <span class="keyword">new</span>(<span class="keyword">struct</span> Node);</div><div class="line">    node-&gt;data = data;</div><div class="line">    node-&gt;left = node-&gt;right = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> (node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> ListNode</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="keyword">struct</span> ListNode* next;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">struct</span> ListNode* <span class="title">newListNode</span><span class="params">(<span class="keyword">int</span> data)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> ListNode* node = <span class="keyword">new</span> (<span class="keyword">struct</span> ListNode);</div><div class="line">    node-&gt;data = data;</div><div class="line">    node-&gt;next = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> (node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">traverseNode</span><span class="params">(<span class="keyword">struct</span> Node* root, <span class="keyword">int</span> level, <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt;&amp; lists)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (lists.size() &lt; level + <span class="number">1</span>) &#123;</div><div class="line">        lists.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    lists[level].push_back(root-&gt;data);</div><div class="line">    traverseNode(root-&gt;left, level+<span class="number">1</span>, lists);</div><div class="line">    traverseNode(root-&gt;right, level+<span class="number">1</span>, lists);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printTree</span><span class="params">(<span class="keyword">struct</span> Node* root)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; lists;</div><div class="line">    traverseNode(root, <span class="number">0</span>, lists);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lists.size(); i++) &#123;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt; <span class="string">"Level "</span>&lt;&lt;i&lt;&lt;<span class="string">":"</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; lists[i].size(); j++) &#123;</div><div class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">" "</span>&lt;&lt;lists[i][j];</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printList</span><span class="params">(<span class="keyword">struct</span> ListNode* first)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> ListNode* p = first;</div><div class="line">    <span class="keyword">while</span> (p) &#123;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;p-&gt;data;</div><div class="line">        <span class="keyword">if</span> (p-&gt;next) &#123;</div><div class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">"-&gt;"</span>;</div><div class="line">        &#125;</div><div class="line">        p = p-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">struct</span> ListNode* first)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (first == <span class="literal">NULL</span> || first-&gt;next == <span class="literal">NULL</span> || first-&gt;next-&gt;next == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> ListNode* p1 = first;</div><div class="line">    <span class="keyword">struct</span> ListNode* p2 = first-&gt;next;</div><div class="line">    <span class="keyword">struct</span> ListNode* t = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> ListNode* q = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> (p2) &#123;</div><div class="line">        <span class="keyword">if</span> (i%<span class="number">2</span> != <span class="number">0</span>) &#123;</div><div class="line">            t = p2;</div><div class="line">            p1-&gt;next = t-&gt;next;</div><div class="line">            t-&gt;next = q;</div><div class="line">            q = t;</div><div class="line">            p2 = p1-&gt;next;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            p1 = p2;</div><div class="line">            p2 = p1-&gt;next;</div><div class="line">        &#125;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    p1-&gt;next = q;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// driver program to test above function</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> ListNode* first = newListNode(<span class="number">1</span>);</div><div class="line">    first-&gt;next = newListNode(<span class="number">2</span>);</div><div class="line">    first-&gt;next-&gt;next = newListNode(<span class="number">3</span>);</div><div class="line">    first-&gt;next-&gt;next-&gt;next = newListNode(<span class="number">4</span>);</div><div class="line">    first-&gt;next-&gt;next-&gt;next-&gt;next = newListNode(<span class="number">5</span>);</div><div class="line">    first-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next = newListNode(<span class="number">6</span>);</div><div class="line">    </div><div class="line">    printList(first);</div><div class="line">    test(first);</div><div class="line">    printList(first);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/07/12/reverse-alternate-levels-of-a-perfect-binary-tree/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/12/reverse-alternate-levels-of-a-perfect-binary-tree/" itemprop="url">
                  Reverse alternate levels of a perfect binary tree
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-12T16:10:38+08:00">
              2014-07-12
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/07/12/reverse-alternate-levels-of-a-perfect-binary-tree/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/07/12/reverse-alternate-levels-of-a-perfect-binary-tree/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Given a Perfect Binary Tree, reverse the alternate level nodes of the binary tree.</p>
<p>Given tree:<br>               a<br>            /     \<br>           b       c<br>         /  \     /  \<br>        d    e    f    g<br>       / \  / \  / \  / \<br>       h  i j  k l  m  n  o </p>
<p>Modified tree:<br>                    a<br>            /     \<br>           c       b<br>         /  \     /  \<br>        d    e    f    g<br>       / \  / \  / \  / \<br>      o  n m  l k  j  i  h<br>We strongly recommend to minimize the browser and try this yourself first.</p>
<p>A simple solution is to do following steps.<br>1) Access nodes level by level.<br>2) If current level is odd, then store nodes of this level in an array.<br>3) Reverse the array and store elements back in tree.</p>
<p>A tricky solution is to do two inorder traversals. Following are steps to be followed.<br>1) Traverse the given tree in inorder fashion and store all odd level nodes in an auxiliary array. For the above example given tree, contents of array become {h, i, b, j, k, l, m, c, n, o}</p>
<p>2) Reverse the array. The array now becomes {o, n, c, m, l, k, j, b, i, h}</p>
<p>3) Traverse the tree again inorder fashion. While traversing the tree, one by one take elements from array and store elements from array to every odd level traversed node.<br>For the above example, we traverse ‘h’ first in above array and replace ‘h’ with ‘o’. Then we traverse ‘i’ and replace it with n.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// C++ program to find maximum path sum between two leaves of</span></div><div class="line"><span class="comment">// a binary tree</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="comment">// A binary tree node</span></div><div class="line"><span class="keyword">struct</span> Node</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> data;</div><div class="line">    <span class="keyword">struct</span> Node* left, *right;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Utility function to allocate memory for a new node</span></div><div class="line"><span class="function"><span class="keyword">struct</span> Node* <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> data)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> Node* node = <span class="keyword">new</span>(<span class="keyword">struct</span> Node);</div><div class="line">    node-&gt;data = data;</div><div class="line">    node-&gt;left = node-&gt;right = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> (node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">traverseNode</span><span class="params">(<span class="keyword">struct</span> Node* root, <span class="keyword">int</span> level, <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt;&amp; lists)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (lists.size() &lt; level + <span class="number">1</span>) &#123;</div><div class="line">        lists.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    lists[level].push_back(root-&gt;data);</div><div class="line">    traverseNode(root-&gt;left, level+<span class="number">1</span>, lists);</div><div class="line">    traverseNode(root-&gt;right, level+<span class="number">1</span>, lists);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printTree</span><span class="params">(<span class="keyword">struct</span> Node* root)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; lists;</div><div class="line">    traverseNode(root, <span class="number">0</span>, lists);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lists.size(); i++) &#123;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt; <span class="string">"Level "</span>&lt;&lt;i&lt;&lt;<span class="string">":"</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; lists[i].size(); j++) &#123;</div><div class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">" "</span>&lt;&lt;lists[i][j];</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">replaceNode</span><span class="params">(<span class="keyword">struct</span> Node* root, <span class="keyword">int</span> level, <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt;&amp; lists)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (lists[level].size() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (level%<span class="number">2</span> != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">size_t</span> count = lists[level].size();</div><div class="line">        root-&gt;data = lists[level][count - <span class="number">1</span>];</div><div class="line">        lists[level].pop_back();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    replaceNode(root-&gt;left, level+<span class="number">1</span>, lists);</div><div class="line">    replaceNode(root-&gt;right, level+<span class="number">1</span>, lists);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverseTree</span><span class="params">(<span class="keyword">struct</span> Node* root)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; lists;</div><div class="line">    traverseNode(root, <span class="number">0</span>, lists);</div><div class="line">    replaceNode(root, <span class="number">0</span>, lists);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// driver program to test above function</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> Node *root = newNode(<span class="number">1</span>);</div><div class="line">    root-&gt;left = newNode(<span class="number">2</span>);</div><div class="line">    root-&gt;right = newNode(<span class="number">3</span>);</div><div class="line">    </div><div class="line">    root-&gt;left-&gt;left = newNode(<span class="number">4</span>);</div><div class="line">    root-&gt;left-&gt;right = newNode(<span class="number">5</span>);</div><div class="line">    root-&gt;right-&gt;left = newNode(<span class="number">6</span>);</div><div class="line">    root-&gt;right-&gt;right = newNode(<span class="number">7</span>);</div><div class="line">    </div><div class="line">    root-&gt;left-&gt;left-&gt;left = newNode(<span class="number">8</span>);</div><div class="line">    root-&gt;left-&gt;left-&gt;right = newNode(<span class="number">9</span>);</div><div class="line">    root-&gt;left-&gt;right-&gt;left = newNode(<span class="number">10</span>);</div><div class="line">    root-&gt;left-&gt;right-&gt;right = newNode(<span class="number">11</span>);</div><div class="line">    </div><div class="line">    root-&gt;right-&gt;left-&gt;left = newNode(<span class="number">12</span>);</div><div class="line">    root-&gt;right-&gt;left-&gt;right = newNode(<span class="number">13</span>);</div><div class="line">    root-&gt;right-&gt;right-&gt;left = newNode(<span class="number">14</span>);</div><div class="line">    root-&gt;right-&gt;right-&gt;right = newNode(<span class="number">15</span>);</div><div class="line">    </div><div class="line">    printTree(root);</div><div class="line">    </div><div class="line">    reverseTree(root);</div><div class="line">    </div><div class="line">    printTree(root);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/05/11/add-customize-commander-into-facebook-chisel/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/11/add-customize-commander-into-facebook-chisel/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-05-11T00:00:00+08:00">
              2014-05-11
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/05/11/add-customize-commander-into-facebook-chisel/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/05/11/add-customize-commander-into-facebook-chisel/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>layout: post<br>title: “Add customize commander into Facebook Chisel”<br>date: 2014-05-11 10:13:51 +0800<br>comments: true<br>categories: 技术</p>
<h2 id="tags-lldb"><a href="#tags-lldb" class="headerlink" title="tags: lldb"></a>tags: lldb</h2><h2 id="1-How-the-chisel-init"><a href="#1-How-the-chisel-init" class="headerlink" title="1. How the chisel init"></a>1. How the chisel init</h2><p>When the lldb init, it will location the file <code>~/.lldbinit</code>, this is the API to add extend commander into lldb. In this file, there is a commander like:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">command</span> script import ~/chisel/fblldb.py</div></pre></td></tr></table></figure></p>
<p>This commander means it will import the script ~/chisel/fblldb.py. Let’s look into fblldb.py. There is lldb callback function named <code>__lldb_init_module</code>. Its function is load python funciton into lldb. Facebook add logic to fecth all the commanders under folder commands. After find all the commander, it will use following command to load them into lldb.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadCommand</span><span class="params">(module, command, directory, filename, extension)</span>:</span></div><div class="line">  func = makeRunCommand(command, os.path.join(directory, filename + extension))</div><div class="line">  name = command.name()</div><div class="line">  </div><div class="line">  key = filename + <span class="string">'_'</span> + name</div><div class="line">  </div><div class="line">  module._loadedFunctions[key] = func</div><div class="line">  </div><div class="line">  functionName = <span class="string">'__'</span> + key</div><div class="line"></div><div class="line">  lldb.debugger.HandleCommand(<span class="string">'script '</span> + functionName + <span class="string">' = sys.modules[\''</span> + module.__name__ + <span class="string">'\']._loadedFunctions[\''</span> + key + <span class="string">'\']'</span>)</div><div class="line">  lldb.debugger.HandleCommand(<span class="string">'command script add -f '</span> + functionName + <span class="string">' '</span> + name)</div></pre></td></tr></table></figure>
<p>Next, how doesn’t this script find all the commanders in folder commander.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadCommandsInDirectory</span><span class="params">(commandsDirectory)</span>:</span></div><div class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(commandsDirectory):</div><div class="line">    fileName, fileExtension = os.path.splitext(file)</div><div class="line">    <span class="keyword">if</span> fileExtension == <span class="string">'.py'</span>:</div><div class="line">      module = imp.load_source(fileName, os.path.join(commandsDirectory, file))</div><div class="line"></div><div class="line">      <span class="keyword">if</span> hasattr(module, <span class="string">'lldbinit'</span>):</div><div class="line">        module.lldbinit()</div><div class="line"></div><div class="line">      <span class="keyword">if</span> hasattr(module, <span class="string">'lldbcommands'</span>):</div><div class="line">        module._loadedFunctions = &#123;&#125;</div><div class="line">        <span class="keyword">for</span> command <span class="keyword">in</span> module.lldbcommands():</div><div class="line">          loadCommand(module, command, commandsDirectory, fileName, fileExtension)</div></pre></td></tr></table></figure></p>
<p>Here we know, we should add function named <code>lldbinit</code> and <code>lldbcommands</code>. Actually, <code>lldbcommands</code> is a list of all the commands in that file.<br>Choose one display commands category.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">lldbcommands</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    FBCoreAnimationFlushCommand(),</div><div class="line">    FBDrawBorderCommand(),</div><div class="line">    FBRemoveBorderCommand(),</div><div class="line">    FBMaskViewCommand(),</div><div class="line">    FBUnmaskViewCommand(),</div><div class="line">    FBShowViewCommand(),</div><div class="line">    FBHideViewCommand(),</div><div class="line">  ]</div></pre></td></tr></table></figure><br>In chisel, each commander is using one class to represent. Take command <code>FBShowViewCommand()</code> for example. It is subclass of <code>FBCommand</code> defined in file fblldbinit.py. In this class, there are 5 public methods defined<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FBCommand</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">options</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">return</span> []</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">args</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">return</span> []</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">description</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, arguments, option)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure><br>All the command should implement parts of above methods. The function - run will be called in fblldb - <code>makeRunCommand</code>.</p>
<h2 id="2-Add-customized-commander"><a href="#2-Add-customized-commander" class="headerlink" title="2. Add customized commander."></a>2. Add customized commander.</h2><p>Till now, we have recogornized how chisel works. So let’s learn how to add our customized commander into it. Recently, our Mobile team in MicroStrategy wants to enhance this tool to integrate with our issue report system - TQMS. In our TQMS system, we could get the general information of an issue. Different issue may use different mobile server. Each time, we should open the issue and find this config link for this mobile server. Then paste it into safari or other place to open it to load our app. It is very wasting time. So we want to add a function that input the TQMS id and generate config link and document path (this is related with our product, let’s just define as MicroStrategy Toturial-&gt;Sandbox-&gt;njiang-&gt;test) for us and apply the url and document path in our app.<br>Here we have get our requirement.  </p>
<pre><code>1. Get config url and document from TQMS system.
2. Apply the config link into our system
3. Find the document path and open the folder.
</code></pre><p>Let’s start to work.</p>
<p>###2.1 Get config url and document from TQMS system<br>Here comes the problem. How could we get the issue information. Here we use chrome develop tools. Then we could find it uses GetAllCommunicationsTypes to get issue information.<br>And its request header is<br><img src="/uploads/2014-05-11/1.png" class="center"><br>You coulde see, we only send a json string, which contains the issue id. In this case, the issue id is 880507. Then we could generate the response text which contains issue information, like comments, full description and so on. Meanwhile, all the information is orignized with json formatting. So it is easy for us to generate the key inforamtion.<br><img src="/uploads/2014-05-11/2.png" class="center"></p>
<p>Here I want to share with you an open source lib of python - requests. You could find this lib here <a href="http://docs.python-requests.org/en/latest/" target="_blank" rel="external">http://docs.python-requests.org/en/latest/</a>. The setup steps are very easy. </p>
<p>Input <code>python setup install</code> in the terminal. Of course, you should <code>cd requests</code> first.</p>
<p>During parse this json string, I found the session of TQMS system will be expired. So I do some research on how to web server to authorize. Actually, our system use IIS authorization, domain corp. After generate authorization, we will add authorization cookies into request header. So now our aim is to get the authorizaiton cookies.<br>There is a login.asp, we can use our corp id and password to get authorization. Here we will use another lib of requests - requests - ntlm. You could find it here <a href="https://github.com/requests/requests-ntlm" target="_blank" rel="external">https://github.com/requests/requests-ntlm</a>.<br>Use the same method to install it as requests.</p>
<p>Get authorization cookies code is like below:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAuthorizationCookies</span><span class="params">(username)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'msilldbconfighelpers.py - getAuthorizationCookies'</span></div><div class="line">    password = getpass.getpass(<span class="string">'Password for '</span> + username + <span class="string">': '</span>)</div><div class="line">    login_url = <span class="string">'https://XXXXXXX.com/Technology/TQMSWeb/login/login.aspx?ReturnUrl=%2fTechnology%2fTQMSWeb%2fviewissue%2fviewissuewindow.aspx%3fid%3d877255%26searchid%3d2746652&amp;id=877255&amp;searchid=2746652'</span></div><div class="line">    response = requests.get(login_url, auth = HttpNtlmAuth(username, password))</div><div class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</div><div class="line">        <span class="keyword">return</span> response.request._cookies</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure></p>
<p>After we get the authorization, then composite a request header for tqms web service.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">combinationRequestHeaders</span><span class="params">(cookies)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'msilldbconfighelpers.py - combinationRequestHeaders'</span></div><div class="line">    headers = &#123; <span class="string">"Connection"</span>: <span class="string">"keep-alive"</span>,</div><div class="line">                <span class="string">"Content-Length"</span>: <span class="number">20</span>,</div><div class="line">                <span class="string">"Accept"</span>: <span class="string">"application/json, text/javascript, */*; q=0.01"</span>,</div><div class="line">                <span class="string">"Origin"</span>: <span class="string">"https://XXXXXXXX.com"</span>,</div><div class="line">                <span class="string">"X-Requested-With"</span>: <span class="string">"XMLHttpRequest"</span>,</div><div class="line">                <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.131 Safari/537.36"</span>,</div><div class="line">                <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</div><div class="line">                <span class="string">"Referer"</span>: <span class="string">"https://XXXXXXXX.com/Technology/TQMSWeb/viewissue/viewissuewindow.aspx?id=882018"</span>,</div><div class="line">                <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip,deflate,sdch"</span>,</div><div class="line">                <span class="string">"Accept-Language"</span>: <span class="string">"en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4"</span>,</div><div class="line">                <span class="string">"Cookie"</span>: cookies&#125;</div><div class="line">    <span class="keyword">return</span> headers</div></pre></td></tr></table></figure></p>
<p>Then get config url and document using following method:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTQMSInformationDict</span><span class="params">(tqms)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        config_path = getConfigFilePath()</div><div class="line">        <span class="keyword">if</span> os.path.isfile(config_path) == <span class="keyword">False</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'Please create an file named "config" under '</span> + config_path + <span class="string">' ! Format with'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'[Login]'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'domain = [the domain]'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'username = [your username]'</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        cf = ConfigParser.ConfigParser()</div><div class="line">        cf.read(config_path)</div><div class="line">        domain = cf.get(<span class="string">'Login'</span>, <span class="string">'domain'</span>)</div><div class="line">        username = cf.get(<span class="string">'Login'</span>, <span class="string">'username'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> domain <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> username <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'Please create an file named "config" under '</span> + config_path + <span class="string">'! Format with\n'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'[Login]'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'domain = [the domain]'</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'username = [your username]'</span></div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        <span class="keyword">print</span> <span class="string">'msilldbconfighelpers.py - getMobileConfigLinkForTQMS'</span></div><div class="line">        username = domain + <span class="string">'\\'</span> + username</div><div class="line">        <span class="comment"># print username</span></div><div class="line">        service_url = <span class="string">'https://XXXXXX.com/technology/tqmsservices/issues.asmx/GetAllComunicationsPerType'</span></div><div class="line">        payload = &#123;<span class="string">"IssueId"</span>: tqms&#125;</div><div class="line">        json_data = json.dumps(payload)</div><div class="line"></div><div class="line">        <span class="comment"># 1. Try to use local cookies</span></div><div class="line">        cookies_read_from_file = <span class="keyword">True</span></div><div class="line">        cookies = getCookies()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> cookies <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            cookies = getAuthorizationCookies(username)</div><div class="line">            <span class="keyword">if</span> cookies <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> <span class="string">"Failed to get the authorization for username: %s"</span> % username</div><div class="line">            recordCookies(cookies)</div><div class="line">            cookies_read_from_file = <span class="keyword">False</span></div><div class="line"></div><div class="line">        cookies_str = dumpCookies(cookies)</div><div class="line"></div><div class="line">        <span class="comment"># 2. get details description response string for tqms</span></div><div class="line">        headers = combinationRequestHeaders(cookies_str)</div><div class="line">        response = requests.post(service_url, data=json_data, headers=headers)</div><div class="line"></div><div class="line">        <span class="keyword">print</span> response.status_code</div><div class="line"></div><div class="line">        <span class="keyword">if</span> response.status_code != <span class="number">200</span> <span class="keyword">and</span> cookies_read_from_file == <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"Try to relogin with Username!"</span></div><div class="line">            cookies = getAuthorizationCookies(username)</div><div class="line">            <span class="keyword">if</span> cookies <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> <span class="string">"Failed to get the authorization with Username: %s"</span> % username</div><div class="line">            recordCookies(cookies)</div><div class="line">            cookies_str = dumpCookies(cookies)</div><div class="line">            headers = combinationRequestHeaders(cookies_str)</div><div class="line">            response = requests.post(service_url, data=json_data, headers=headers)</div><div class="line">            <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</div><div class="line">                <span class="keyword">raise</span> <span class="string">"Failed to get the authorization with Username: %s"</span> % username</div><div class="line"></div><div class="line">        <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</div><div class="line">            <span class="keyword">raise</span> <span class="string">"Failed to get the authorization with Username!"</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># 3. parse json string</span></div><div class="line">            issue_infos = json.loads(response.text)[<span class="string">'d'</span>]</div><div class="line">            full_description_u = issue_infos[<span class="string">'Description'</span>]</div><div class="line">            comments_u = issue_infos[<span class="string">'Comments'</span>]</div><div class="line">            full_description = full_description_u.encode(<span class="string">"utf-8"</span>)</div><div class="line">            comments = comments_u.encode(<span class="string">"utf-8"</span>)</div><div class="line">            <span class="keyword">if</span> full_description <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> full_description == <span class="string">''</span>:</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Failed to get the full description for TQMS: %s"</span> % tqms)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                config_url = generateConfigURLLink(comments, full_description)</div><div class="line">                document_path = generateDocumentPath(comments, full_description)</div><div class="line">                path_separator = getSeparatorForDocumentPath(document_path)</div><div class="line">                <span class="keyword">return</span> &#123;<span class="string">"url"</span>: config_url, <span class="string">"document"</span>: document_path, <span class="string">"separator"</span>: path_separator&#125;</div><div class="line">                </div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        <span class="keyword">print</span> e</div></pre></td></tr></table></figure></p>
<p>###2.2 Apply url<br>After generate url link, we will turn to MSIConfigCommand. The class is like below.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">lldbcommands</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        MSIConfigCommand()</div><div class="line">    ]</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MSIConfigCommand</span><span class="params">(fb.FBCommand)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'config'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">description</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Config MSTR Mobile Application with URL/TQMS id.'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">options</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [</div><div class="line">                fb.FBCommandArgument(short=<span class="string">'-u'</span>, long=<span class="string">'--url'</span>, arg=<span class="string">'url'</span>, type=<span class="string">'string'</span>, default=<span class="string">''</span>, help=<span class="string">'Config mobile app with url'</span>),</div><div class="line">                fb.FBCommandArgument(short=<span class="string">'-d'</span>, long=<span class="string">'--id'</span>, arg=<span class="string">'id'</span>, type=<span class="string">'string'</span>, default=<span class="string">'880507'</span>, help=<span class="string">'TQMS ID'</span>)</div><div class="line">        ]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getPureUrlLink</span><span class="params">(self, dirty_url)</span>:</span></div><div class="line">        <span class="keyword">if</span> dirty_url <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        results = dirty_url.split(<span class="string">' '</span>)</div><div class="line">        <span class="keyword">for</span> str <span class="keyword">in</span> results:</div><div class="line">            <span class="keyword">if</span> str != <span class="string">''</span>:</div><div class="line">                <span class="keyword">return</span> str</div><div class="line"></div><div class="line"><span class="comment">#    def args(self):</span></div><div class="line"><span class="comment">#        return [ fb.FBCommandArgument(arg='url', type='string', help='The config url.', default='')]</span></div><div class="line"></div><div class="line"><span class="comment"># expr [[[UIApplication sharedApplication] delegate] application:application openURL:url sourceApplication:sourceApplication annotation:annotation]</span></div><div class="line"><span class="comment"># application = [UIApplication sharedApplication]</span></div><div class="line"><span class="comment"># url = [above]</span></div><div class="line"><span class="comment"># sourceApplication = @"com.apple.mobilesafari"</span></div><div class="line"><span class="comment"># annotation = NSDictionary</span></div><div class="line"><span class="comment"># &#123;</span></div><div class="line"><span class="comment">#     ReferrerURL = "http://10.197.34.70/";</span></div><div class="line"><span class="comment"># &#125;</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, args, options)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'------ start config ------'</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.id == <span class="string">""</span> <span class="keyword">and</span> options.url == <span class="string">""</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"error, -d or -u missing!"</span></div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        <span class="comment"># 1. Generate url and document path first</span></div><div class="line">        <span class="keyword">if</span> options.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> options.id != <span class="string">""</span>:</div><div class="line">            tqms_dict = getTQMSInformationDict(options.id)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> tqms_dict:</div><div class="line">                <span class="keyword">if</span> tqms_dict[key] <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> tqms_dict[key] == <span class="string">""</span>:</div><div class="line">                    <span class="keyword">print</span> <span class="string">"Error when get %s for TQMS: %s"</span> % (key, options.id)</div><div class="line"></div><div class="line">            config_url = tqms_dict[<span class="string">'url'</span>]</div><div class="line">            document_path = tqms_dict[<span class="string">'document'</span>]</div><div class="line">            path_separator = tqms_dict[<span class="string">'separator'</span>]</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> options.url <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> options.url != <span class="string">""</span>:</div><div class="line">            config_url = options.url</div><div class="line"></div><div class="line">        config_url = self.getPureUrlLink(config_url)</div><div class="line">        <span class="keyword">print</span> <span class="string">"config_url = %s"</span> % config_url</div><div class="line">        <span class="keyword">print</span> <span class="string">"document_path = %s"</span> % document_path</div><div class="line"></div><div class="line">        <span class="comment"># 2. Config the document path into FolderPathSearcher</span></div><div class="line">        <span class="keyword">if</span> document_path <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> path_separator <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            lldb.debugger.HandleCommand(<span class="string">'expression [FolderPathSearcher getInstance]'</span>)</div><div class="line">            <span class="keyword">if</span> document_path <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> document_path != <span class="string">""</span>:</div><div class="line">                expr = <span class="string">'[[FolderPathSearcher getInstance] setSearchPath:@"'</span>+ document_path +<span class="string">'" Separator:@"'</span>+ path_separator +<span class="string">'"]'</span></div><div class="line">                lldb.debugger.HandleCommand(<span class="string">'expression '</span> + expr)</div><div class="line"></div><div class="line">        <span class="comment"># 3. Apply url link</span></div><div class="line">        <span class="keyword">if</span> config_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            url = fb.evaluateExpression(<span class="string">'(NSURL*)[NSURL URLWithString:@"%s"]'</span> % config_url)</div><div class="line">            application = fb.evaluateExpression(<span class="string">'(UIApplication*)[UIApplication sharedApplication]'</span>)</div><div class="line">            delegate = fb.evaluateExpression(<span class="string">'[(UIApplication*)%s delegate]'</span> % application)</div><div class="line">            lldb.debugger.HandleCommand(<span class="string">'expr (void)[%s application:%s openURL:%s sourceApplication:nil annotation:nil]'</span> % (delegate, application, url))</div><div class="line">            <span class="keyword">print</span> <span class="string">'------ end config ------'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'Failed to generate the url link, please check your url or TQMS ID is correct!'</span></div><div class="line"></div><div class="line">        <span class="comment"># 4. Continue run our app</span></div><div class="line">        lldb.debugger.SetAsync(<span class="keyword">True</span>)</div><div class="line">        lldb.debugger.GetSelectedTarget().GetProcess().Continue()</div></pre></td></tr></table></figure></p>
<p>You can see we add two options for this command “-d” and “-u”. When config our app, we use system callback function - <code>[UIApplicationDelegate application: openURL: sourceApplication:nil annotation:nil]</code>. </p>
<p>###2.3 Find document path<br>This we get projects system information is async. So we should add logic to handle this. I will add this part later.</p>
<p>###2.4 Continue lldb automatically<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lldb.debugger.SetAsync(<span class="keyword">True</span>)</div><div class="line">lldb.debugger.GetSelectedTarget().GetProcess().Continue()</div></pre></td></tr></table></figure></p>
<p>##3 Write auto setup shell script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"------ Start Config Chisel ------"</span></div><div class="line"></div><div class="line">curPath=`<span class="built_in">pwd</span>`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$curPath</span></div><div class="line">lldbinitFile=<span class="string">".lldbinit"</span></div><div class="line"><span class="built_in">cd</span> ~</div><div class="line"><span class="keyword">if</span> [[ ! <span class="_">-f</span> <span class="string">"<span class="variable">$lldbinitFile</span>"</span> ]]; <span class="keyword">then</span></div><div class="line">	touch <span class="string">"<span class="variable">$lldbinitFile</span>"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	rm <span class="string">"<span class="variable">$lldbinitFile</span>"</span></div><div class="line">	touch <span class="string">"<span class="variable">$lldbinitFile</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">#echo "# ~/.lldbinit" &gt;&gt; $lldbinitFile</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"command script import "</span><span class="variable">$curPath</span><span class="string">"/fblldb.py"</span> &gt;&gt; <span class="variable">$lldbinitFile</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$curPath</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Please input the following information:"</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"domain = "</span></div><div class="line"><span class="built_in">read</span> domain</div><div class="line"><span class="built_in">echo</span> -n <span class="string">"username = "</span></div><div class="line"><span class="built_in">read</span> username</div><div class="line"></div><div class="line">configPath=<span class="string">"/tmp/MicroStrategy"</span></div><div class="line">configFile=<span class="string">"/tmp/MicroStrategy/TQMS.cfg"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$configPath</span>"</span> ]; <span class="keyword">then</span></div><div class="line">	mkdir <span class="string">"<span class="variable">$configPath</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [[ ! <span class="_">-f</span> <span class="string">"<span class="variable">$configFile</span>"</span> ]]; <span class="keyword">then</span></div><div class="line">	touch <span class="string">"<span class="variable">$configFile</span>"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	rm <span class="string">"<span class="variable">$configFile</span>"</span></div><div class="line">	touch <span class="string">"<span class="variable">$configFile</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"[Login]"</span> &gt;&gt; <span class="variable">$configFile</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"domain = "</span><span class="variable">$domain</span> &gt;&gt; <span class="variable">$configFile</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"username = "</span><span class="variable">$username</span> &gt;&gt; <span class="variable">$configFile</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> packages/requests</div><div class="line">sudo python setup.py install</div><div class="line"><span class="built_in">cd</span> ../requests-ntlm</div><div class="line">sudo python setup.py install</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"------ Config Chisel Finished -------"</span></div></pre></td></tr></table></figure>
<p>##4 How to use</p>
<p>###4.1 Setup:<br>After you download the source code, run the following command in Terminal  </p>
<ol>
<li>cd chisel</li>
<li>./setup.sh<br> a. input your domain, like “corp”<br> b. input you corp id, like “XXXX”<br> c. input user password (this password is your Mac OS user’s password, it is used to run sudo command. For corp password, it will require later in how-to #2.)</li>
</ol>
<p>###4.2 How-to:<br>We added a new command named “config” in the python script. There are two options “-u” and “-d”. “-u” means using url to configuration our app. “-d” means using TQMS id to fetch the config url and configuration our app. You could run our app in debug mode. After app launches,  </p>
<ol>
<li>Pause our app manually.</li>
<li>You could input any one of following two commands, if it is the first time you run this command or the login cookie is expired, you need to input your corp id password to generate a new login cookie. It will not store the password information.<br>a. config –u [a url link]<br>b. config –d 854318</li>
</ol>
<p>###4.3 Discussion:</p>
<ol>
<li>About setup.sh, I have combined the setting commands into one shell script. It will do the following things:<br> a. Re-create ~/.lldbinit. ~/.lldbinit is used to init lldb extend script, like import python script.<br> b. After get user corp id, it will store the information in “/tmp/MicroStrategy/TQMS.cfg”.<br> c. Install two depends libs: requests and requests-ntlm. These two libs are used to get the authorization login cookies.</li>
<li>About login cookies, if there is no login success cookies or the success login cookie is expired, we will first try to login the corp id and get the login success cookie. After get the authorization cookies, we will store this information in “/tmp/MicroStratety/TQMS.cookies”. If the cookies is useable, we will re-use this cookies to generate configuration url link.</li>
<li>About generate URL config link, currently, we will find string, which starts with “mstr:///” (Thanks for Liang’s comments). Now it is fine. But if there is 2 or more configuration link in the full description, it will be hard to determine which one is needed. I am wondered whether we could ask QE to format the configuration link and document path.</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/05/05/zi-xuan-suo/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/05/05/zi-xuan-suo/" itemprop="url">
                  自旋锁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-05-05T22:45:34+08:00">
              2014-05-05
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/05/05/zi-xuan-suo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/05/05/zi-xuan-suo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Linux 2.4.x及以前的版本都是非抢占式内核方式，如果编译成单处理器系统，在同一时间只有一个进程在执行，除非它自己放弃，不然只有通过”中断”才能中断其 执行。因此，在单处理器非抢占式内核中，如果需要修改某个重要的数据结构，或者执行某些关键代码，只需要禁止中断。（只有禁止中断）</p>
<p>在对称多处理器，仅仅禁止某个CPU的中断是不够的，当然我们也可以将所有CPU的中断都禁止，但这样做开销很 大，整个系统的性能会明显下降。此外，即使在单处理器上，如果内核是抢占式的，也可能出现不同进程上下文同时进入临界区的情况。为此，Linux内核中提 供了”自旋锁（spinlock）”的同步机制。 （只是禁止中断是不行的，引入spinlock)</p>
<p>自旋锁与互斥锁有点类似，只是自旋锁不会引起调用者睡眠，如果自旋锁已经被别的执行单元保持，调用者就一直循环在那里看是否该自旋锁的保持者已经释放了锁，”自旋”因此而得名. (自旋锁不会睡眠，只会在那里不停的循环等待）</p>
<p>因此，中断（或软中断）禁止用于防止同一CPU上中断（或软中断）对共享资源的非同步访问。而自旋锁则防止在不同CPU上的执行单元对共享资源的同时访问，以及不同进程上下文互相抢占导致的对共享资源的非同步访问。<br>自旋锁的代码在include/asm-i386 (spinlock.h  spinlock_types.h)代码是以汇编的形式写的。<br>如何才能在那里不停的循环等待呢。很简单，用code来实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">do</span></div><div class="line">&#123;&#125;</div><div class="line"><span class="keyword">while</span>（<span class="number">0</span>）</div></pre></td></tr></table></figure>
<p>js/jmp等汇编跳转语句<br>Linux内核中的自旋锁<br>在Linux内核中，自旋锁的基本使用方式如下：<br>先声明一个spinlock_t类型的自旋锁变量，并初始化为”未加锁”状态。在进入临界区之前，调用加锁函数获得锁，在退出临界区之前，调用解锁函数释放锁。例如：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">spinlock_t lock = SPIN_LOCK_UNLOCKED;</div><div class="line">spin_lock(&amp;amp;lock);</div><div class="line"><span class="comment">/* 临界区 */</span></div><div class="line">spin_unlock(&amp;amp;lock);</div></pre></td></tr></table></figure></p>
<p>获得自旋锁和释放自旋锁的函数有多种变体。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spin_lock_irqsave/spin_unlock_irqrestore</div><div class="line">spin_lock_irq/spin_unlock_irq</div><div class="line">spin_lock_bh/spin_unlock_bh/spin_trylock_bh</div></pre></td></tr></table></figure></p>
<p>上面各组函数最终都需要调用自旋锁操作函数。spin_lock函数用于获得自旋锁，如果能够立即获得锁，它就马 上返回，否则，它将自旋在那里，直到该自旋锁的保持者释放。spin_unlock函数则释放自旋锁。此外，还有一个spin_trylock函数。尽力 获得自旋锁lock，如果能立即获得锁，它获得锁并返回真，否则不能立即获得锁，立即返回假。它不会自旋等待lock被释放<br>code解释：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> lock;</div><div class="line">&#125; spinlock_t;</div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> spin_lock(spinlock_t *lock)</div><div class="line">&#123;</div><div class="line">	__asm__ __volatile__(</div><div class="line">	spin_lock_string</div><div class="line">	:<span class="string">"=m"</span> (lock-&lt;lock) : : <span class="string">"memory"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>从上看到，spin_lock的主要内容是spin_lock_string宏，定义如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define spin_lock_string \</span></div><div class="line"><span class="string">"\n1:\t"</span> \</div><div class="line"><span class="string">"lock ; decb %0\n\t"</span> \</div><div class="line"><span class="string">"js 2f\n"</span> \</div><div class="line">LOCK_SECTION_START(<span class="string">""</span>) \</div><div class="line"><span class="string">"2:\t"</span> \</div><div class="line"><span class="string">"cmpb $0,%0\n\t"</span> \</div><div class="line"><span class="string">"rep;nop\n\t"</span> \</div><div class="line"><span class="string">"jle 2b\n\t"</span> \</div><div class="line"><span class="string">"jmp 1b\n"</span> \</div><div class="line">LOCK_SECTION_END</div></pre></td></tr></table></figure><br>在上面的汇编代码中，首先将lock递减，如果为负（表明锁已被持有），则进入自旋。每次自旋在执行一条空指令后，根据lock和0的比较结果进行跳转。如果lock小于或等于0，则继续自旋；否则（说明锁已被释放），则将lock递减后返回。<br>在这里，采取了一种优化手段，因为在大多数情况下，自旋锁是能成功获取的，而自旋部分代码，只是在锁被持有时才执行，因此利用 LOCK_SECTION_START和LOCK_SECTION_END将这些代码放到一个专门的区（.text.lock）中。如果把它跟别的常用指 令混在一起，会浪费指令缓存的空间。<br>理解这一点，我们也就能明白spin_lock是如何退出的了。事实上，由于不再同一个区（section），所以”js 2f”的下一条指令并不是”cmpb $0,%0”。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define LOCK_SECTION_NAME     \</span></div><div class="line"><span class="string">".text.lock."</span> __stringify(KBUILD_BASENAME)</div><div class="line"><span class="meta">#define LOCK_SECTION_START(extra)    \</span></div><div class="line"><span class="string">".subsection 1\n\t"</span>     \</div><div class="line">extra       \</div><div class="line"><span class="string">".ifndef "</span> LOCK_SECTION_NAME <span class="string">"\n\t"</span> \</div><div class="line">LOCK_SECTION_NAME <span class="string">":\n\t"</span>    \</div><div class="line"><span class="string">".endif\n\t"</span></div><div class="line"><span class="meta">#define LOCK_SECTION_END     \</span></div><div class="line"><span class="string">".previous\n\t"</span></div></pre></td></tr></table></figure></p>
<p>如果用类C语言来描述上述过程，将是：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> spin_lock(<span class="keyword">int</span> &amp;amp;lock)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> flag;</div><div class="line">label1:</div><div class="line">	flag = lock--;</div><div class="line">	<span class="keyword">if</span> (flag &lt;= <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125; </div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">do</span> &#123;</div><div class="line">			nop;</div><div class="line">		&#125; <span class="keyword">while</span>(lock &lt;= <span class="number">0</span>);</div><div class="line">		<span class="keyword">goto</span> label1;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于spin_trylock不需要自旋，实现中采用xchgb指令（该指令将自动锁总线，而不需要再使用lock前缀）。若lock原来的值为1，说明未上锁，因此返回为真，表明成功获得锁；否则返回为假。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">spin_trylock</span><span class="params">(<span class="keyword">spinlock_t</span> *lock)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> oldval;</div><div class="line">	__asm__ __volatile__(</div><div class="line">	<span class="string">"xchgb %b0,%1"</span></div><div class="line">	:<span class="string">"=q"</span> (oldval), <span class="string">"=m"</span> (lock-&lt;lock)</div><div class="line">	:<span class="string">"0"</span> (<span class="number">0</span>) : <span class="string">"memory"</span>);</div><div class="line">	<span class="keyword">return</span> oldval &lt; <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>自旋锁的应用<br>在讨论自旋锁的应用时，我们一般区分两种平台：单处理器非抢占式内核和对称多处理器或抢占式内核。在前面我们看到，在单处理器非抢占式内核下，自旋锁根本 不存在。这体现了一种出色的设计策略，既然没有别人能够同时刻执行，就没有理由加锁。对于抢占式内核，我们将它等同于对称多处理器来考虑。  </p>
<ol>
<li>用户上下文之间<br>如果数据结构只可能被用户上下文访问，最高效的办法就是使用信号量。（我们在后面将讨论信号量机制）。  </li>
<li>用户上下文与softirq之间<br>这种情况下，使用spin_lock_bh()/spin_unlock_bh()可以满足要求。如果是单处理器非抢占式内核，自旋锁消失 了，spin_lock_bh等同于local_bh_disable，会进制在用户上下文时进制softirq，从而避免用户上下文和softirq同 时进入临界区。如果是对称多处理器或者抢占式内核，即使是在不同CPU上的用户上下文和softirq同时运行，自旋锁机制保证了只有一个持有者，只有在 它释放锁之后，另一个才能进入临界区。  </li>
<li>用户上下文和Tasklet/Timer之间<br>同上。同加锁观点来看，Tasklet和Timer的地位是同样的。</li>
<li>Tasklet或Timer之间<br>这里有两点需要说明：（1）同一时刻，一个Tasklet或Timer不会同时在两个CPU上执行；（2）如果CPU已经处在Tasklet或Timer 中，它不会同时再执行其它的Tasklet或Timer。因此我们只需要考虑在不同CPU上运行两个不同Tasklet或Timer的情况，而这种情况只 需要使用自旋锁机制，即spin_lock和spin_unlock函数。</li>
<li>Softirq之间或和Tasklet/Timer之间<br>同一个softirq可能在不同的CPU上执行，同上道理，使用spin_lock和spin_unlock可以在不同CPU的同一个或不同softirq，或者Softirq与Tasklet或Timer之间保护共享数据。</li>
<li>硬件中断之间<br>如果被保护的共享资源在软中断（包括tasklet和timer）或进程上下文和硬中断上下文访问，那么在软中断或进程上下文访问期间，可能被硬中断打 断，从而进入硬中断上下文对共享资源进行访问，因此，在进程或软中断上下文需要使用spin_lock_irq和spin_unlock_irq来保护对 共享资源的访问。<br>而在中断处理句柄中使用什么版本，需依情况而定，如果只有一个中断处理句柄访问该共享资源，那么在中断处理句柄中仅需要spin_lock和spin_unlock来保护对共享资源的访问就可以了。<br>因为在执行中断处理句柄期间，不可能被同一CPU上的软中断或进程打断。但是如果有不同的中断处理句柄访问该共享资源，那么需要在中断处理句柄中使用spin_lock_irq和spin_unlock_irq来保护对共享资源的访问。  </li>
</ol>
<p>在使用spin_lock_irq和spin_unlock_irq的情况下，完全可以用spin_lock_irqsave和 spin_unlock_irqrestore取代，具体应该使用哪一个也需要依情况而定，如果可以确信在对共享资源访问前中断是打开的，那么使用 spin_lock_irq更好一些，因为它比spin_lock_irqsave要快一些。<br>但是如果不能确定是否中断使能，那么使用spin_lock_irqsave和spin_unlock_irqrestore更好，因为它将恢复访问共享 资源前的中断标志而不是直接打开中断。 当然，有些情况下需要在访问共享资源时必须禁止中断，而访问完后必须打开中断，这样的情形使用spin_lock_irq和 spin_unlock_irq最好。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2014/04/17/nsstying-yong-retainhuan-shi-copy/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/17/nsstying-yong-retainhuan-shi-copy/" itemprop="url">
                  NSString应用retain还是copy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-04-17T19:41:07+08:00">
              2014-04-17
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/17/nsstying-yong-retainhuan-shi-copy/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/17/nsstying-yong-retainhuan-shi-copy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>对NSString应用retain，效率无疑是最好的</p>
</li>
<li><p>用copy最安全，因为NSString 为 NSMutableString 的基类，如果将NSMutableString 以retain的形式赋值给NSString后，后续修改NSMutableString会导致NSString内容的变化，这通常不是我们希望的，所以用copy最安全。</p>
</li>
<li><p>到底用哪个？貌似还是用copy，因为copy并不一定导致一个新对对象创建，而牺牲效率。copy会调用NSCopying中的 -(id)copyWithZone:(NSZone *)，我们可以判断下self是NSString还是NSMutableString，如果是NSString，就地[self  retain]，[return self]。否则老老实实拷贝对象赋值，这样可以实现效率和安全的结合，实验的结果也是如此。</p>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span>* strOrgin = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"curr time is %@"</span>, [<span class="built_in">NSDate</span> date]];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"strOrgin = %p, retainCount = %d"</span>, strOrgin, [strOrgin retainCount]);</div><div class="line"><span class="built_in">NSString</span>* strCopy = [strOrgin <span class="keyword">copy</span>];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"strCopy = %p, retainCount=%d"</span>, strCopy, [strCopy retainCount]);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"strOrgin = %p, retainCount = %d"</span>, strOrgin, [strOrgin retainCount]);</div></pre></td></tr></table></figure>
<hr>
<p>output<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Test[<span class="number">50250</span>:<span class="number">707</span>] strOrgin = <span class="number">0x1e52e4d0</span>, retainCount = <span class="number">1</span></div><div class="line">Test[<span class="number">50250</span>:<span class="number">707</span>] strCopy = <span class="number">0x1e52e4d0</span>, retainCount=<span class="number">2</span></div><div class="line">Test[<span class="number">50250</span>:<span class="number">707</span>] strOrgin = <span class="number">0x1e52e4d0</span>, retainCount = <span class="number">2</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar/avatar.jpg"
               alt="姜楠" />
          <p class="site-author-name" itemprop="name">姜楠</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">117</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/njiang1987" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">姜楠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"njiang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
