<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="天空の城">
<meta property="og:url" content="http://www.njiang.cn/page/11/index.html">
<meta property="og:site_name" content="天空の城">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="天空の城">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.njiang.cn/page/11/"/>





  <title> 天空の城 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-43682645-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">天空の城</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">愤怒的程序员，梦想着有一天也能飞！</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/16/stackoverflownsoperation-he-dispatch_async-de-qu-bie/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/16/stackoverflownsoperation-he-dispatch_async-de-qu-bie/" itemprop="url">
                  [StackOverflow]NSOperation和dispatch_async的区别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-16T00:00:00+08:00">
              2013-09-16
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/16/stackoverflownsoperation-he-dispatch_async-de-qu-bie/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/16/stackoverflownsoperation-he-dispatch_async-de-qu-bie/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>NSOperation*</code> classes are the higher level api. They hide GCD’s lower level api from you so that you can concentrate on getting the task done.</p>

<p>The rule of thumb is: <strong>Use the api of the highest level first and then degrade based on what you need to accomplish.</strong></p>

<p>The advantage of this approach is that your code stays most agnostic to the specific implementation the vendor provides. In this example, using <code>NSOperation</code>, you’ll be using Apple’s implementation of execution queueing (using GCD). Should Apple ever decide to change the details of implementation behind the scenes they can do so without breaking your application’s code.<br><br>One such example would be Apple deprecating GCD and using a completely different library (which is unlikely because Apple created GCD and everybody seems to love it).</p>

<p>Regarding the matter i recommend consulting the following resources:<br><ul><br>    <li><a href="http://cocoasamurai.blogspot.de/2009/09/guide-to-blocks-grand-central-dispatch.html" target="_blank" rel="external">http://cocoasamurai.blogspot.de/2009/09/guide-to-blocks-grand-central-dispatch.html</a></li><br>    <li><a href="http://cocoasamurai.blogspot.de/2009/09/making-nsoperation-look-like-gcd.html" target="_blank" rel="external">http://cocoasamurai.blogspot.de/2009/09/making-nsoperation-look-like-gcd.html</a></li><br>    <li><a href="http://www.raywenderlich.com/19788/how-to-use-nsoperations-and-nsoperationqueues" target="_blank" rel="external">http://www.raywenderlich.com/19788/how-to-use-nsoperations-and-nsoperationqueues</a></li><br>    <li><a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/NSOperationQueue_class/Reference/Reference.html" target="_blank" rel="external">https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/NSOperationQueue_class/Reference/Reference.html</a></li><br></ul></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/16/zhuan-zai-ios-duo-xian-cheng-bian-cheng-zhi-nan/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/16/zhuan-zai-ios-duo-xian-cheng-bian-cheng-zhi-nan/" itemprop="url">
                  [转载]iOS多线程编程指南（四）线程同步
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-16T00:00:00+08:00">
              2013-09-16
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/16/zhuan-zai-ios-duo-xian-cheng-bian-cheng-zhi-nan/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/16/zhuan-zai-ios-duo-xian-cheng-bian-cheng-zhi-nan/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><div>[转自]<a href="http://www.dreamingwish.com/dream-2012/the-ios-multithreaded-programming-guide-4-thread-synchronization.html" target="_blank" rel="external">http://www.dreamingwish.com/dream-2012/the-ios-multithreaded-programming-guide-4-thread-synchronization.html</a></div><br><div><br>应用程序里面多个线程的存在引发了多个执行线程安全访问资源的潜在问题。两个线程同时修改同一资源有可能以意想不到的方式互相干扰。比如，一个线程可能覆盖其他线程改动的地方，或让应用程序进入一个未知的潜在无效状态。如果你幸运的话，受损的资源可能会导致明显的性能问题或崩溃，这样比较容易跟踪并修复它。然而如果你不走运，资源受损可能导致微妙的错误，这些错误不会立即显现出来，而是很久之后才出现，或者导致其他可能需要一个底层的编码来显著修复的错误。</div></p>

<p>但涉及到线程安全时，一个好的设计是最好的保护。避免共享资源，并尽量减少线程间的相互作用，这样可以让它们减少互相的干扰。但是一个完全无干扰的设计是不可能的。在线程必须交互的情况下，你需要使用同步工具，来确保当它们交互的时候是安全的。</p>

<p>Mac OS X和iOS提供了你可以使用的多个同步工具，从提供互斥访问你程序的有序的事件的工具等。以下个部分介绍了这些工具和如何在代码中使用他们来影响安全的访问程序的资源。<br></p><h2>1.1        同步工具</h2><br>为了防止不同线程意外修改数据，你可以设计你的程序没有同步问题，或你也可以使用同步工具。尽管完全避免出现同步问题相对更好一点，但是几乎总是无法实现。以下个部分介绍了你可以使用的同步工具的基本类别。<br><h3>1.1.1    原子操作</h3><br>原子操作是同步的一个简单的形式，它处理简单的数据类型。原子操作的优势是它们不妨碍竞争的线程。对于简单的操作，比如递增一个计数器，原子操作比使用锁具有更高的性能优势。<p></p>

<p>Mac OS X和iOS包含了许多在32位和64位执行基本的数学和逻辑运算的操作。这些操作都使用了原子版本来操作比较和交换，测试和设置，测试和清理等。查看支持原子操作的列表，参阅/user/include/libkern/OSAtomic.h头文件和参见atomic主页。<br></p><h3>1.1.2    内存屏障和 Volatile 变量</h3><br>为了达到最佳性能，编译器通常会对汇编基本的指令进行重新排序来尽可能保持处理器的指令流水线。作为优化的一部分，编译器有可能对访问主内存的指令，如果它认为这有可能产生不正确的数据时，将会对指令进行重新排序。不幸的是，靠编译器检测到所有可能内存依赖的操作几乎总是不太可能的。如果看似独立的变量实际上是相互影响，那么编译器优化有可能把这些变量更新位错误的顺序，导致潜在不不正确结果。<p></p>

<p>内存屏障（memory barrier）是一个使用来确保内存操作按照正确的顺序工作的非阻塞的同步工具。内存屏障的作用就像一个栅栏，迫使处理器来完成位于障碍前面的任何加载和存储操作，才允许它执行位于屏障之后的加载和存储操作。内存屏障同样使用来确保一个线程（但对另外一个线程可见）的内存操作总是按照预定的顺序完成。如果在这些地方缺少内存屏障有可能让其他线程看到看似不可能的结果（比如，内存屏障的维基百科条目）。为了使用一个内存屏障，你只要在你代码里面需要的地方简单的调用OSMemoryBarrier函数。</p>

<p>Volatile 变量适用于独立变量的另一个内存限制类型。编译器优化代码通过加载这些变量的值进入寄存器。对于本地变量，这通常不会有什么问题。但是如果一个变量对另外一个线程可见，那么这种优化可能会阻止其他线程发现变量的任何变化。在变量之前加上关键字volatile可以强制编译器每次使用变量的时候都从内存里面加载。如果一个变量的值随时可能给编译器无法检测的外部源更改，那么你可以把该变量声明为volatile变量。</p>

<p>因为内存屏障和volatile变量降低了编译器可执行的优化，因此你应该谨慎使用它们，只在有需要的地方时候，以确保正确性。关于更多使用内存屏障的信息，参阅OSMemoryBarrier主页。<br></p><h3>1.1.3    锁</h3><br>锁是最常用的同步工具。你可以是使用锁来保护临界区(<strong>critical section</strong>)，这些代码段在同一个时间只能允许被一个线程访问。比如，一个临界区可能会操作一个特定的数据结构，或使用了每次只能一个客户端访问的资源。<p></p>

<p>表4-1列出了程序最常使用的锁。Mac OS X和iOS提供了这些锁里面大部分类型的实现，但是并不是全部实现。对于不支持的锁类型，说明列解析了为什么这些锁不能直接在平台上面实现的原因。<br></p><p align="center"><strong>Table 4-1</strong>  Lock types</p><p></p>

<p><table border="1" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td valign="top" width="150px">Lock</td><br><td valign="top">Description</td><br></tr><br><tr><br><td>Mutex[互斥锁]</td><br><td>A mutually exclusive (or <strong>mutex</strong>) lock acts as a protective barrier around a resource. A mutex is a type of semaphore that grants access to only one thread at a time. If a mutex is in use and another thread tries to acquire it, that thread blocks until the mutex is released by its original holder. If multiple threads compete for the same mutex, only one at a time is allowed access to it.</td><br></tr><br><tr><br><td>Recursive lock[递归锁]</td><br><td>A recursive lock is a variant on the mutex lock. A recursive lock allows a single thread to acquire the lock multiple times before releasing it. Other threads remain blocked until the owner of the lock releases the lock the same number of times it acquired it. Recursive locks are used during recursive iterations primarily but may also be used in cases where multiple methods each need to acquire the lock separately.</td><br></tr><br><tr><br><td>Read-write lock<br><br>[读写锁]</td><br><td>A read-write lock is also referred to as a shared-exclusive lock. This type of lock is typically used in larger-scale operations and can significantly improve performance if the protected data structure is read frequently and modified only occasionally. During normal operation, multiple readers can access the data structure simultaneously. When a thread wants to write to the structure, though, it blocks until all readers release the lock, at which point it acquires the lock and can update the structure. While a writing thread is waiting for the lock, new reader threads block until the writing thread is finished. The system supports read-write locks using POSIX threads only. For more information on how to use these locks, see the <a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/pthread.3.html#//apple_ref/doc/man/3/pthread" target="_blank" rel="external">pthread</a> man page.</td><br></tr><br><tr><br><td>Distributed lock<br><br>[分布锁]</td><br><td>A distributed lock provides mutually exclusive access at the process level. Unlike a true mutex, a distributed lock does not block a process or prevent it from running. It simply reports when the lock is busy and lets the process decide how to proceed.</td><br></tr><br><tr><br><td>Spin lock<br><br>[自旋锁]</td><br><td>A spin lock polls its lock condition repeatedly until that condition becomes true. Spin locks are most often used on multiprocessor systems where the expected wait time for a lock is small. In these situations, it is often more efficient to poll than to block the thread, which involves a context switch and the updating of thread data structures. The system does not provide any implementations of spin locks because of their polling nature, but you can easily implement them in specific situations. For information on implementing spin locks in the kernel, see<em>Kernel Programming Guide</em>.</td><br></tr><br><tr><br><td>Double-checked lock<br><br>[双重检查锁]</td><br><td>A double-checked lock is an attempt to reduce the overhead of taking a lock by testing the locking criteria prior to taking the lock. Because double-checked locks are potentially unsafe, the system does not provide explicit support for them and their use is discouraged.[注意系统不显式支持该锁类型]</td><br></tr><br></tbody><br></table><br><blockquote><strong>注意：</strong><em>大部分锁类型都合并了内存屏障来确保在进入临界区之前它前面的加载和存储指令都已经完成。</em></blockquote><br>关于如何使用锁的信息，参阅”使用锁”部分。<br></p><h3>1.1.4    条件</h3><br>条件是<strong>信号量</strong>的另外一个形式，它允许在条件为真的时候线程间互相发送信号。条件通常被使用来说明资源可用性，或用来确保任务以特定的顺序执行。当一个线程测试一个条件时，它会被阻塞直到条件为真。它会一直阻塞直到其他线程显式的修改信号量的状态。条件和互斥锁(mutex lock)的区别在于多个线程被允许同时访问一个条件。条件更多是允许不同线程根据一些指定的标准通过的守门人。<p></p>

<p>一个方式是你使用条件来管理挂起事件的池。事件队列可能使用条件变量来给等待线程发送信号，此时它们在事件队列中的时候。如果一个事件到达时，队列将给条件发送合适信号。如果一个线程已经处于等待，它会被唤醒，届时它将会取出事件并处理它。如果两个事件到达队列的时间大致相同，队列将会发送两次信号唤醒两个线程。</p>

<p>系统通过几个不同的技术来支持条件。然而正确实现条件需要仔细编写代码，因此你应该在你自己代码中使用条件之前查看”使用条件”部分的例子。<br></p><h3>1.1.5    执行Selector例程</h3><br>Cocoa程序包含了一个在一个线程以同步的方式传递消息的方便方法。NSObject类声明方法来在应用的一个活动线程上面执行selector的方法。这些方法允许你的线程以异步的方式来传递消息，以确保它们在同一个线程上面执行是同步的。比如，你可以通过执行selector消息来把一个从你分布计算的结果传递给你的应用的主线程或其他目标线程。每个执行selector的请求都会被放入一个目标线程的run loop的队列里面，然后请求会按照它们到达的顺序被目标线程有序的处理。<p></p>

<p>关于执行selector例程的总结和更多关于如何使用它们的信息，参阅Cocoa执行Selector源。<br></p><h2>1.2        同步的成本和性能</h2><br>同步帮助确保你代码的正确性，但同时将会牺牲部分性能。甚至在无争议的情况下，同步工具的使用将在后面介绍。锁和原子操作通常包含了内存屏障和内核级别同步的使用来确保代码正确被保护。如果，发生锁的争夺，你的线程有可能进入阻塞，在体验上会产生更大的迟延。<p></p>

<p>表4-2列出了在无争议情况下使用互斥锁和原子操作的近似的相关成本。这些测试的平均值是使用了上千的样本分析出的结果。随着线程创建时间的推移，互斥采集时间（即使在无争议情况下）可能相差也很大，这依赖于进程的加载，计算机的处理速度和系统和程序现有可用的内存。<br></p><p align="center"><strong>Table 4-2</strong>  Mutex and atomic operation costs</p><p></p>

<p><table border="1" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td valign="top" width="150px">Item</td><br><td valign="top" width="200px">Approximate cost</td><br><td valign="top">Notes</td><br></tr><br><tr><br><td>Mutex acquisition time</td><br><td>Approximately 0.2 microseconds<br><br>[0.2微秒]</td><br><td>This is the lock acquisition time in an uncontested case. If the lock is held by another thread, the acquisition time can be much greater. The figures were determined by analyzing the mean and median values generated during mutex acquisition on an Intel-based iMac with a 2 GHz Core Duo processor and 1 GB of RAM running Mac OS X v10.5.</td><br></tr><br><tr><br><td>Atomic compare-and-swap</td><br><td>Approximately 0.05 microseconds<br><br>[0.05微秒]</td><br><td>This is the compare-and-swap time in an uncontested case. The figures were determined by analyzing the mean and median values for the operation and were generated on an Intel-based iMac with a 2 GHz Core Duo processor and 1 GB of RAM running Mac OS X v10.5.</td><br></tr><br></tbody><br></table><br>当设计你的并发任务时，正确性是最重要的因素，但是也要考虑性能因素。代码在多个线程下面正确执行，但比相同代码在当线程执行慢，这是难以改善的。如果你是改造已有的单线程应用，你应该始终给关键任务的性能设置测量基线。当增加额外线程后，对相同的任务你应该采取新的测量方法并比较多线程和单线程情况下的性能状况。在改变代码之后，线程并没有提高性能，你应该需要重新考虑具体的实现或同时使用线程。</p>

<p>关于性能的信息和收集指标的工具，参阅Performance Overview。关于锁原子成本的特定信息，参阅”线程成本”部分。<br></p><h2>1.3        线程安全和信号量</h2><br>当涉及到多线程应用程序时，没有什么比处理信号量更令人恐惧和困惑的了。信号量是底层BSD机制，它可以用来传递信息给进程或以某种方式操纵它。一些应用程序使用信号量来检测特定事件，比如子进程的消亡。系统使用信号量来终止失控进程，和作为其他类型的通信消息。<p></p>

<p>使用信号量的问题并不是你要做什么，而是当你程序是多线程的时候它们的行为。在当线程应用程序里面，所有的信号量处理都在主线程进行。在多线程应用程序里面，信号量被传递到恰好运行的线程，而不依赖于特定的硬件错误（比如非法指令）。如果多个线程同时运行，信号量被传递到任何一个系统挑选的线程。换而言之，信号量可以传递给你应用的任何线程。</p>

<p>在你应用程序里面实现信号量处理的第一条规则是避免假设任一线程处理信号量。如果一个指定的线程想要处理给定的信号，你需要通过某些方法来通知该线程信号何时到达。你不能只是假设该线程的一个信号处理例程的安装会导致信号被传递到同一线程里面。</p>

<p>关于更多信号量的信息和信号量处理例程的安装信息，参见signal和sigaction主页。<br></p><h2>1.4        线程安全设计的技巧</h2><br>同步工具是让你代码安全的有用方法，但是它们并非灵丹妙药。使用太多锁和其他同步的类型原语和非多线程相比明显会降低你应用的线程性能。在性能和安全之间寻找平衡是一门需要经验的艺术。以下各部分提供帮助你为你应用选择合适的同步级别的技巧。<br><h3>1.4.1    完全避免同步</h3><br>对于你新的项目，甚至已有项目，设计你的代码和数据结构来避免使用同步是一个很好的解决办法。虽然锁和其他类型同步工具很有用，但是它们会影响任何应用的性能。而且如果整体设计导致特定资源的高竞争，你的线程可能需要等待更长时间。<p></p>

<p>实现并发最好的方法是减少你并发任务之间的交互和相互依赖。如果每个任务在它自己的数据集上面操作，那它不需要使用锁来保护这些数据。甚至如果两个任务共享一个普通数据集，你可以查看分区方法，它们设置或提供拷贝每一项任务的方法。当然，拷贝数据集本身也需要成本，所以在你做出决定前，你需要权衡这些成本和使用同步工具造成的成本那个更可以接受。<br></p><h3>1.4.2    了解同步的限制</h3><br>同步工具只有当它们被用在应用程序中的所有线程是一致时才是有效的。如果你创建了互斥锁来限制特定资源的访问，你所有线程都必须在试图操纵资源前获得同一互斥锁。如果不这样做导致破坏一个互斥锁提供的保护，这是编程的错误。<br><h3>1.4.3    注意对代码正确性的威胁</h3><br>当你使用锁和内存屏障时，你应该总是小心的把它们放在你代码正确的地方。即使有条件的锁（似乎很好放置）也可能会让你产生一个虚假的安全感。以下一系列例子试图通过指出看似无害的代码的漏洞来举例说明该问题。其基本前提是你有一个可变的数组，它包含一组不可变的对象集。假设你想要调用数组中第一个对象的方法。你可能会做类似下面那样的代码：<br><pre>NSLock<em> arrayLock = GetArrayLock();<br>NSMutableArray</em> myArray = GetSharedArray();<br>id anObject;</pre><p></p>

<p>[arrayLock lock];<br><br>anObject = [myArray objectAtIndex:0];<br><br>[arrayLock unlock];</p>

<p>[anObject doSomething];<br><div align="center"></div><br>因为数组是可变的，所有数组周围的锁防止其他线程修改该数组直到你获得了想要的对象。而且因为对象限制它们本身是不可更改的，所以在调用对象的doSomething方法周围不需要锁。</p>

<p>但是上面显式的例子有一个问题。如果当你释放该锁，而在你有机会执行doSomething方法前其他线程到来并从数组中删除所有对象，那会发生什么呢？对于没有使用垃圾回收的应用程序，你代码用户的对象可能已经释放了，让anObject对象指向一个非法的内存地址。了修正该问题，你可能决定简单的重新安排你的代码，让它在调用doSomething之后才释放锁，如下所示：<br><div align="center"></div><br><pre>NSLock<em> arrayLock = GetArrayLock();<br>NSMutableArray</em> myArray = GetSharedArray();<br>id anObject;</pre></p>

<p>[arrayLock lock];<br><br>anObject = [myArray objectAtIndex:0];<br><br>[anObject doSomething];<br><br>[arrayLock unlock];<br>通过把doSomething的调用移到锁的内部，你的代码可以保证该方法被调用的时候该对象还是有效的。不幸的是，如果doSomething方法需要耗费很长的时间，这有可能导致你的代码保持拥有该锁很长时间，这会产生一个性能瓶颈。</p>

<p>该代码的问题不是关键区域定义不清，而是实际问题是不可理解的。真正的问题是由其他线程引发的内存管理的问题。因为它可以被其他线程释放，最好的解决办法是在释放锁之前retain anObject。该解决方案涉及对象被释放，并没有引发一个强制的性能损失。<br><div align="center"></div><br><pre>NSLock<em> arrayLock = GetArrayLock();<br>NSMutableArray</em> myArray = GetSharedArray();<br>id anObject;</pre></p>

<p>[arrayLock lock];<br><br>anObject = [myArray objectAtIndex:0];<br><br>[anObject retain];<br><br>[arrayLock unlock];</p>

<p>[anObject doSomething];<br><br>[anObject release];<br>尽管前面的例子非常简单，它们说明了非常重要的一点。当它涉及到正确性时，你需要考虑不仅仅是问题的表面。内存管理和其他影响你设计的因子都有可能因为出现多个线程而受到影响，所以你必须考虑从上到下考虑这些问题。此外，你应该在涉及安全的时候假设编译器总是出现最坏的情况。这种意识和警惕性，可以帮你避免潜在的问题，并确保你的代码运行正确。</p>

<p>关于更多介绍如何让你应用程序安全的额外例子，参阅Technical Note TN2059:”Using Collection Classes Safely in Multithreaded Application”。<br></p><h3>1.4.4    当心死锁（Deadlocks）和活锁(Livelocks)</h3><br>任何时候线程试图同时获得多于一个锁，都有可能引发潜在的死锁。当两个不同的线程分别保持一个锁（而该锁是另外一个线程需要的）又试图获得另外线程保持的锁时就会发生死锁。结果是每个线程都会进入持久性阻塞状态，因为它永远不可能获得另外那个锁。<p></p>

<p>一个活锁和死锁类似，当两个线程竞争同一个资源的时候就可能发生活锁。在发生活锁的情况里，一个线程放弃它的第一个锁并试图获得第二个锁。一旦它获得第二个锁，它返回并试图再次获得一个锁。线程就会被锁起来，因为它花费所有的时间来释放一个锁，并试图获取其他锁，而不做实际的工作。</p>

<p>避免死锁和活锁的最好方法是同一个时间只拥有一个锁。如果你必须在同一时间获取多于一个锁，你应该确保其他线程没有做类似的事情。<br></p><h3>1.4.5    正确使用Volatile变量</h3><br>如果你已经使用了一个互斥锁来保护一个代码段，不要自动假设你需要使用关键词volatile来保护该代码段的重要的变量。一个互斥锁包含了内存屏障来确保加载和存储操作是按照正确顺序的。在一个临界区添加关键字volatile到变量上面会强制每次访问该变量的时候都要从内存里面从加载。这两种同步技巧的组合使用在一些特定区域是必须的，但是同样会导致显著的性能损失。如果单独使用互斥锁已经可以保护变量，那么忽略关键字volatile。<p></p>

<p>为了避免使用互斥锁而不使用volatile变量同样很重要。通常情况下，互斥锁和其他同步机制是比volatile变量更好的方式来保护数据结构的完整性。关键字volatile只是确保从内存加载变量而不是使用寄存器里面的变量。它不保证你代码访问变量是正确的。<br></p><h2>1.5        使用原子操作</h2><br>非阻塞同步的方式是用来执行某些类型的操作而避免扩展使用锁。尽管锁是同步两个线程的很好方式，获取一个锁是一个很昂贵的操作，即使在无竞争的状态下。相比，许多原子操作花费很少的时间来完成操作也可以达到和锁一样的效果。<p></p>

<p>原子操作可以让你在32位或64位的处理器上面执行简单的数学和逻辑的运算操作。这些操作依赖于特定的硬件设施（和可选的内存屏障）来保证给定的操作在影响内存再次访问的时候已经完成。在多线程情况下，你应该总是使用原子操作，它和内存屏障组合使用来保证多个线程间正确的同步内存。</p>

<p>表4-3列出了可用的原子运算和本地操作和相应的函数名。这些函数声明在/usr/include/libkern/OSAtomic.h头文件里面，在那里你也可以找到完整的语法。这些函数的64-位版本只能在64位的进程里面使用。<br></p><p align="center"><strong>Table 4-3</strong>  Atomic math and logic operations</p><p></p>

<p><div align="center"><br><table border="1" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td valign="top" width="150px">Operation</td><br><td valign="top" width="300px">Function name</td><br><td valign="top">Description</td><br></tr><br><tr><br><td>Add</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAdd32.3.html#//apple_ref/doc/man/3/OSAtomicAdd32" target="_blank" rel="external">OSAtomicAdd32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAdd32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicAdd32Barrier" target="_blank" rel="external">OSAtomicAdd32Barrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAdd64.3.html#//apple_ref/doc/man/3/OSAtomicAdd64" target="_blank" rel="external">OSAtomicAdd64</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAdd64Barrier.3.html#//apple_ref/doc/man/3/OSAtomicAdd64Barrier" target="_blank" rel="external">OSAtomicAdd64Barrier</a></td><br><td>Adds two integer values together and stores the result in one of the specified variables.</td><br></tr><br><tr><br><td>Increment</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicIncrement32.3.html#//apple_ref/doc/man/3/OSAtomicIncrement32" target="_blank" rel="external">OSAtomicIncrement32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicIncrement32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicIncrement32Barrier" target="_blank" rel="external">OSAtomicIncrement32Barrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicIncrement64.3.html#//apple_ref/doc/man/3/OSAtomicIncrement64" target="_blank" rel="external">OSAtomicIncrement64</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicIncrement64Barrier.3.html#//apple_ref/doc/man/3/OSAtomicIncrement64Barrier" target="_blank" rel="external">OSAtomicIncrement64Barrier</a></td><br><td>Increments the specified integer value by 1.</td><br></tr><br><tr><br><td>Decrement</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicDecrement32.3.html#//apple_ref/doc/man/3/OSAtomicDecrement32" target="_blank" rel="external">OSAtomicDecrement32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicDecrement32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicDecrement32Barrier" target="_blank" rel="external">OSAtomicDecrement32Barrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicDecrement64.3.html#//apple_ref/doc/man/3/OSAtomicDecrement64" target="_blank" rel="external">OSAtomicDecrement64</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicDecrement64Barrier.3.html#//apple_ref/doc/man/3/OSAtomicDecrement64Barrier" target="_blank" rel="external">OSAtomicDecrement64Barrier</a></td><br><td>Decrements the specified integer value by 1.</td><br></tr><br><tr><br><td>Logical OR</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicOr32.3.html#//apple_ref/doc/man/3/OSAtomicOr32" target="_blank" rel="external">OSAtomicOr32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicOr32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicOr32Barrier" target="_blank" rel="external">OSAtomicOr32Barrier</a></td><br><td>Performs a logical OR between the specified 32-bit value and a 32-bit mask.</td><br></tr><br><tr><br><td>Logical AND</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAnd32.3.html#//apple_ref/doc/man/3/OSAtomicAnd32" target="_blank" rel="external">OSAtomicAnd32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicAnd32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicAnd32Barrier" target="_blank" rel="external">OSAtomicAnd32Barrier</a></td><br><td>Performs a logical AND between the specified 32-bit value and a 32-bit mask.</td><br></tr><br><tr><br><td>Logical XOR</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicXor32.3.html#//apple_ref/doc/man/3/OSAtomicXor32" target="_blank" rel="external">OSAtomicXor32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicXor32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicXor32Barrier" target="_blank" rel="external">OSAtomicXor32Barrier</a></td><br><td>Performs a logical XOR between the specified 32-bit value and a 32-bit mask.</td><br></tr><br><tr><br><td>Compare and swap</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwap32.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwap32" target="_blank" rel="external">OSAtomicCompareAndSwap32</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwap32Barrier.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwap32Barrier" target="_blank" rel="external">OSAtomicCompareAndSwap32Barrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwap64.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwap64" target="_blank" rel="external">OSAtomicCompareAndSwap64</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwap64Barrier.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwap64Barrier" target="_blank" rel="external">OSAtomicCompareAndSwap64Barrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapPtr.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapPtr" target="_blank" rel="external">OSAtomicCompareAndSwapPtr</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapPtrBarrier.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapPtrBarrier" target="_blank" rel="external">OSAtomicCompareAndSwapPtrBarrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapInt.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapInt" target="_blank" rel="external">OSAtomicCompareAndSwapInt</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapIntBarrier.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapIntBarrier" target="_blank" rel="external">OSAtomicCompareAndSwapIntBarrier</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapLong.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapLong" target="_blank" rel="external">OSAtomicCompareAndSwapLong</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicCompareAndSwapLongBarrier.3.html#//apple_ref/doc/man/3/OSAtomicCompareAndSwapLongBarrier" target="_blank" rel="external">OSAtomicCompareAndSwapLongBarrier</a></td><br><td>Compares a variable against the specified old value. If the two values are equal, this function assigns the specified new value to the variable; otherwise, it does nothing. The comparison and assignment are done as one atomic operation and the function returns a Boolean value indicating whether the swap actually occurred.</td><br></tr><br><tr><br><td>Test and set</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicTestAndSet.3.html#//apple_ref/doc/man/3/OSAtomicTestAndSet" target="_blank" rel="external">OSAtomicTestAndSet</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicTestAndSetBarrier.3.html#//apple_ref/doc/man/3/OSAtomicTestAndSetBarrier" target="_blank" rel="external">OSAtomicTestAndSetBarrier</a></td><br><td>Tests a bit in the specified variable, sets that bit to 1, and returns the value of the old bit as a Boolean value. Bits are tested according to the formula (0×80 &gt;&gt; (n &amp; 7)) of byte((char<em>)address + (n &gt;&gt; 3)) where n is the bit number and address is a pointer to the variable. This formula effectively breaks up the variable into 8-bit sized chunks and orders the bits in each chunk in reverse. For example, to test the lowest-order bit (bit 0) of a 32-bit integer, you would actually specify 7 for the bit number; similarly, to test the highest order bit (bit 32), you would specify 24 for the bit number.</em></td><br></tr><br><tr><br><td>Test and clear</td><br><td><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicTestAndClear.3.html#//apple_ref/doc/man/3/OSAtomicTestAndClear" target="_blank" rel="external">OSAtomicTestAndClear</a><br><a href="http://developer.apple.com/library/ios/documentation/System/Conceptual/ManPages_iPhoneOS/man3/OSAtomicTestAndClearBarrier.3.html#//apple_ref/doc/man/3/OSAtomicTestAndClearBarrier" target="_blank" rel="external">OSAtomicTestAndClearBarrier</a></td><br><td>Tests a bit in the specified variable, sets that bit to 0, and returns the value of the old bit as a Boolean value. Bits are tested according to the formula (0×80 &gt;&gt; (n &amp; 7)) of byte((char)address + (n &gt;&gt; 3)) where n is the bit number and address is a pointer to the variable. This formula effectively breaks up the variable into 8-bit sized chunks and orders the bits in each chunk in reverse. For example, to test the lowest-order bit (bit 0) of a 32-bit integer, you would actually specify 7 for the bit number; similarly, to test the highest order bit (bit 32), you would specify 24 for the bit number.</td><br></tr><br></tbody><br></table><br></div><br>&nbsp;</p>

<p>大部分原子函数的行为是相对简单的并应该是你想要的。然而列表4-1显式了测试-设置和比较-交换操作的原子行为，它们相对复杂一点。OSAtomicTestAndSet 第一次调用展示了如何对一个整形值进行位运算操作，而它的结果和你预期的有差异。最后两次调用OSAtomicCompareAndSwap32显式它的行为。所有情况下，这些函数都是无竞争的下调用的，此时没有其他线程试图操作这些值。</p>

<p>&nbsp;<br></p><p align="center"><strong>Listing 4-1</strong>  Performing atomic operations</p><p></p>

<p><div align="center"></div><br><pre>int32_t  theValue = 0;<br>OSAtomicTestAndSet(0, &amp;theValue);<br>// theValue is now 128.</pre></p>

<p>theValue = 0;<br><br>OSAtomicTestAndSet(7, &amp;theValue);<br><br>// theValue is now 1.</p>

<p>theValue = 0;<br><br>OSAtomicTestAndSet(15, &amp;theValue)<br><br>// theValue is now 256.</p>

<p>OSAtomicCompareAndSwap32(256, 512, &amp;theValue);<br><br>// theValue is now 512.</p>

<p>OSAtomicCompareAndSwap32(256, 1024, &amp;theValue);<br><br>// theValue is still 512.<br></p><p align="left">关于原子操作的更多信息，参见atomic的主页和/usr/include/libkern/OSAtomic.h头文件。</p><p></p>

<p></p><h2>1.6        使用锁</h2><br>锁是线程编程同步工具的基础。锁可以让你很容易保护代码中一大块区域以便你可以确保代码的正确性。Mac OS X和iOS都位所有类型的应用程序提供了互斥锁，而Foundation框架定义一些特殊情况下互斥锁的额外变种。以下个部分显式了如何使用这些锁的类型。<br><h3>1.6.1    使用POSIX互斥锁</h3><br>POSIX互斥锁在很多程序里面很容易使用。为了新建一个互斥锁，你声明并初始化一个pthread_mutex_t的结构。为了锁住和解锁一个互斥锁，你可以使用pthread_mutex_lock和pthread_mutex_unlock函数。列表4-2显式了要初始化并使用一个POSIX线程的互斥锁的基础代码。当你用完一个锁之后，只要简单的调用pthread_mutex_destroy来释放该锁的数据结构。<br><p align="center"><strong>Listing 4-2</strong>  Using a mutex lock</p><p></p>

<p><div align="center"></div><br><pre>pthread_mutex_t mutex;<br>void MyInitFunction()<br>{<br>    pthread_mutex_init(&amp;mutex, NULL);<br>}</pre></p>

<p>void MyLockingFunction()<br><br>{<br>    pthread_mutex_lock(&amp;mutex);<br><br>    // Do work.<br><br>    pthread_mutex_unlock(&amp;mutex);<br><br>}<br><blockquote><strong>注意：</strong><em>上面的代码只是简单的显式了使用一个POSIX线程互斥锁的步骤。你自己的代码应该检查这些函数返回的错误码，并适当的处理它们。</em></blockquote><br></p><h3>1.6.2    使用NSLock类</h3><br>在Cocoa程序中NSLock中实现了一个简单的互斥锁。所有锁（包括NSLock）的接口实际上都是通过NSLocking协议定义的，它定义了lock和unlock方法。你使用这些方法来获取和释放该锁。<p></p>

<p>除了标准的锁行为，NSLock类还增加了tryLock和lockBeforeDate:方法。方法tryLock试图获取一个锁，但是如果锁不可用的时候，它不会阻塞线程。相反，它只是返回NO。而lockBeforeDate:方法试图获取一个锁，但是如果锁没有在规定的时间内被获得，它会让线程从阻塞状态变为非阻塞状态（或者返回NO）。</p>

<p>下面的例子显式了你可以是NSLock对象来协助更新一个可视化显式，它的数据结构被多个线程计算。如果线程没有立即获的锁，它只是简单的继续计算直到它可以获得锁再更新显式。<br><pre>BOOL moreToDo = YES;<br>NSLock <em>theLock = [[NSLock alloc] init];<br>…<br>while (moreToDo) {<br>    /</em> Do another increment of calculation <em>/<br>    /</em> until there’s no more to do. <em>/<br>    if ([theLock tryLock]) {<br>        /</em> Update display used by all threads. */<br>        [theLock unlock];<br>    }<br>}</pre><br><div align="center"></div><br></p><h3>1.6.3    使用@synchronized指令</h3><br>@synchronized指令是在Objective-C代码中创建一个互斥锁非常方便的方法。@synchronized指令做和其他互斥锁一样的工作（它防止不同的线程在同一时间获取同一个锁）。然而在这种情况下，你不需要直接创建一个互斥锁或锁对象。相反，你只需要简单的使用Objective-C对象作为锁的令牌，如下面例子所示：<br><div align="center"></div><br><pre>- (void)myMethod:(id)anObj<br>{<br>    @synchronized(anObj)<br>    {<br>        // Everything between the braces is protected by the @synchronized directive.<br>    }<br>}</pre><br>创建给@synchronized指令的对象是一个用来区别保护块的唯一标示符。如果你在两个不同的线程里面执行上述方法，每次在一个线程传递了一个不同的对象给anObj参数，那么每次都将会拥有它的锁，并持续处理，中间不被其他线程阻塞。然而，如果你传递的是同一个对象，那么多个线程中的一个线程会首先获得该锁，而其他线程将会被阻塞直到第一个线程完成它的临界区。<p></p>

<p></p><p>作为一种预防措施，@synchronized块隐式的添加一个异常处理例程来保护代码。该处理例程会在异常抛出的时候自动的释放互斥锁。这意味着为了使用@synchronized指令，你必须在你的代码中启用异常处理。了如果你不想让隐式的异常处理例程带来额外的开销，你应该考虑使用锁的类。</p><p></p>
<p></p><p>关于更多@synchronized指令的信息，参阅The Objective-C Programming Language。</p>
<p></p><h3>1.6.4    使用其他Cocoa锁</h3><br>以下个部分描述了使用Cocoa其他类型的锁。<p></p><p></p>
<p>&nbsp;</p>

<p><strong>使用NSRecursiveLock对象</strong></p>

<p>NSRecursiveLock类定义的锁可以在同一线程多次获得，而不会造成死锁。一个递归锁会跟踪它被多少次成功获得了。每次成功的获得该锁都必须平衡调用锁住和解锁的操作。只有所有的锁住和解锁操作都平衡的时候，锁才真正被释放给其他线程获得。</p>

<p>正如它名字所言，这种类型的锁通常被用在一个递归函数里面来防止递归造成阻塞线程。你可以类似的在非递归的情况下使用他来调用函数，这些函数的语义要求它们使用锁。以下是一个简单递归函数，它在递归中获取锁。如果你不在该代码里使用NSRecursiveLock对象，当函数被再次调用的时候线程将会出现死锁。<br><div align="center"></div><br><pre>NSRecursiveLock *theLock = [[NSRecursiveLock alloc] init];</pre></p>

<p>void MyRecursiveFunction(int value)<br><br>{<br>    [theLock lock];<br><br>    if (value != 0)<br><br>    {<br><br>        –value;<br><br>        MyRecursiveFunction(value);<br><br>    }<br><br>    [theLock unlock];<br><br>}</p>

<p>MyRecursiveFunction(5);<br><blockquote><strong>注意：</strong><em>因为一个递归锁不会被释放直到所有锁的调用平衡使用了解锁操作，所以你必须仔细权衡是否决定使用锁对性能的潜在影响。长时间持有一个锁将会导致其他线程阻塞直到递归完成。如果你可以重写你的代码来消除递归或消除使用一个递归锁，你可能会获得更好的性能。<strong></strong></em></blockquote><br><strong> </strong></p>

<p><strong>使用NSConditionLock对象</strong></p>

<p>NSConditionLock对象定义了一个互斥锁，可以使用特定值来锁住和解锁。不要把该类型的锁和条件（参见“条件”部分）混淆了。它的行为和条件有点类似，但是它们的实现非常不同。</p>

<p>通常，当多线程需要以特定的顺序来执行任务的时候，你可以使用一个NSConditionLock对象，比如当一个线程生产数据，而另外一个线程消费数据。生产者执行时，消费者使用由你程序指定的条件来获取锁（条件本身是一个你定义的整形值）。当生产者完成时，它会解锁该锁并设置锁的条件为合适的整形值来唤醒消费者线程，之后消费线程继续处理数据。</p>

<p>NSConditionLock的锁住和解锁方法可以任意组合使用。比如，你可以使用unlockWithCondition:和lock消息，或使用lockWhenCondition:和unlock消息。当然，后面的组合可以解锁一个锁但是可能没有释放任何等待某特定条件值的线程。</p>

<p>下面的例子显示了生产者-消费者问题如何使用条件锁来处理。想象一个应用程序包含一个数据的队列。一个生产者线程把数据添加到队列，而消费者线程从队列中取出数据。生产者不需要等待特定的条件，但是它必须等待锁可用以便它可以安全的把数据添加到队列。<br><div align="center"></div><br><pre>id condLock = [[NSConditionLock alloc] initWithCondition:NO_DATA];</pre></p>

<p>while(true)<br><br>{<br>    [condLock lock];<br><br>    /<em> Add data to the queue. </em>/<br><br>    [condLock unlockWithCondition:HAS_DATA];<br><br>}<br>因为初始化条件锁的值为NO_DATA，生产者线程在初始化的时候可以毫无问题的获取该锁。它会添加队列数据，并把条件设置为HAS_DATA。在随后的迭代中，生产者线程可以把到达的数据添加到队列，无论队列是否为空或依然有数据。唯一让它进入阻塞的情况是当一个消费者线程充队列取出数据的时候。</p>

<p>因为消费者线程必须要有数据来处理，它会使用一个特定的条件来等待队列。当生产者把数据放入队列时，消费者线程被唤醒并获取它的锁。它可以从队列中取出数据，并更新队列的状态。下列代码显示了消费者线程处理循环的基本结构。<br><pre>while (true)<br>{<br>    [condLock lockWhenCondition:HAS_DATA];<br>    /<em> Remove data from the queue. </em>/<br>    [condLock unlockWithCondition:(isEmpty ? NO_DATA : HAS_DATA)];</pre></p>

<p>    // Process the data locally.<br><br>}<br><div align="center"></div><br>&nbsp;</p>

<p><strong>使用NSDistributedLock对象</strong></p>

<p>NSDistributedLock类可以被多台主机上的多个应用程序使用来限制对某些共享资源的访问，比如一个文件。锁本身是一个高效的互斥锁，它使用文件系统项目来实现，比如一个文件或目录。对于一个可用的NSDistributedLock对象，锁必须由所有使用它的程序写入。这通常意味着把它放在文件系统，该文件系统可以被所有运行在计算机上面的应用程序访问。</p>

<p>不像其他类型的锁，NSDistributedLock并没有实现NSLocking协议，所有它没有lock方法。一个lock方法将会阻塞线程的执行，并要求系统以预定的速度轮询锁。以其在你的代码中实现这种约束，NSDistributedLock提供了一个tryLock方法，并让你决定是否轮询。</p>

<p>因为它使用文件系统来实现，一个NSDistributedLock对象不会被释放除非它的拥有者显式的释放它。如果你的程序在用户一个分布锁的时候崩溃了，其他客户端简无法访问该受保护的资源。在这种情况下，你可以使用breadLock方法来打破现存的锁以便你可以获取它。但是通常应该避免打破锁，除非你确定拥有进程已经死亡并不可能再释放该锁。</p>

<p>和其他类型的锁一样，当你使用NSDistributedLock对象时，你可以通过调用unlock方法来释放它。<br></p><h2>1.7        使用条件</h2><br>条件是一个特殊类型的锁，你可以使用它来同步操作必须处理的顺序。它们和互斥锁有微妙的不同。一个线程等待条件会一直处于阻塞状态直到条件获得其他线程显式发出的信号。<p></p>

<p>由于微妙之处包含在操作系统实现上，条件锁被允许返回伪成功，即使实际上它们并没有被你的代码告知。为了避免这些伪信号操作的问题，你应该总是在你的条件锁里面使用一个断言。该断言是一个更好的方法来确定是否安全让你的线程处理。条件简单的让你的线程保持休眠直到断言被发送信号的线程设置了。</p>

<p>以下部分介绍了如何在你的代码中使用条件。<br></p><h3>1.7.1    使用NSCondition类</h3><br>NSCondition类提供了和POSIX条件相同的语义，但是它把锁和条件数据结构封装在一个单一对象里面。结果是一个你可以像互斥锁那样使用的对象，然后等待特定条件。<p></p>

<p>列表4-3显示了一个代码片段，它展示了为等待一个NSCondition对象的事件序列。cocaoCondition变量包含了一个NSCondition对象，而timeToDoWork变量是一个整形，它在其他线程里面发送条件信号时立即递增。<br></p><p align="center"><strong>Listing 4-3</strong>  Using a Cocoa condition</p><p></p>

<p><div align="center"></div><br><pre>[cocoaCondition lock];<br>while (timeToDoWork &lt;= 0)<br>    [cocoaCondition wait];</pre></p>

<p>timeToDoWork–;</p>

<p>// Do real work here.</p>

<p>[cocoaCondition unlock];<br>列表4-4显示了用于给Cocoa条件发送信号的代码，并递增他断言变量。你应该在给它发送信号前锁住条件。<br></p><p align="center"><strong>Listing 4-4</strong>  Signaling a Cocoa condition</p><p></p>

<p><pre>[cocoaCondition lock];<br>timeToDoWork++;<br>[cocoaCondition signal];<br>[cocoaCondition unlock];</pre><br></p><h3>1.7.2    使用POSIX条件</h3><br>POSIX线程条件锁要求同时使用条件数据结构和一个互斥锁。经管两个锁结构是分开的，互斥锁在运行的时候和条件结构紧密联系在一起。多线程等待某一信号应该总是一起使用相同的互斥锁和条件结构。修改该成双结构将会导致错误。<p></p>

<p>列表4-5显示了基本初始化过程，条件和断言的使用。在初始化之后，条件和互斥锁，使用ready_to_go变量作为断言等待线程进入一个while循环。仅当断言被设置并且随后的条件信号等待线程被唤醒和开始工作。<br></p><p align="center"><strong>Listing 4-5</strong>  Using a POSIX condition</p><p></p>

<p><div align="center"></div><br><pre>pthread_mutex_t mutex;<br>pthread_cond_t condition;<br>Boolean     ready_to_go = true;</pre></p>

<p>void MyCondInitFunction()<br><br>{<br>    pthread_mutex_init(&amp;mutex);<br><br>    pthread_cond_init(&amp;condition, NULL);<br><br>}</p>

<p>void MyWaitOnConditionFunction()<br><br>{<br>    // Lock the mutex.<br><br>    pthread_mutex_lock(&amp;mutex);</p>

<p>    // If the predicate is already set, then the while loop is bypassed;<br><br>    // otherwise, the thread sleeps until the predicate is set.<br><br>    while(ready_to_go == false)<br><br>    {<br><br>        pthread_cond_wait(&amp;condition, &amp;mutex);<br><br>    }</p>

<p>    // Do work. (The mutex should stay locked.)</p>

<p>    // Reset the predicate and release the mutex.<br><br>    ready_to_go = false;<br><br>    pthread_mutex_unlock(&amp;mutex);<br><br>}<br>信号线程负责设置断言和发送信号给条件锁。列表4-6显示了实现该行为的代码。在该例子中，条件被互斥锁内被发送信号来防止等待条件的线程间发生竞争条件。<br></p><p align="center"><strong>Listing 4-6</strong>  Signaling a condition lock</p><p></p>

<p><div align="center"><br><pre>void SignalThreadUsingCondition()<br>{<br>    // At this point, there should be work for the other thread to do.<br>    pthread_mutex_lock(&amp;mutex);<br>    ready_to_go = true;</pre></div></p>

<p>    // Signal the other thread to begin work.<br><br>    pthread_cond_signal(&amp;condition);</p>

<p>    pthread_mutex_unlock(&amp;mutex);<br><br>}<br>&nbsp;</p>

<p><br><blockquote><strong>注意：</strong><em>上述代码是显示使用POSIX线程条件函数的简单例子。你自己的代码应该检测这些函数返回错误码并恰当的处理它们。</em></blockquote><br></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/13/zhuan-zai-objective-c-duo-xian-cheng-nsthread/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/13/zhuan-zai-objective-c-duo-xian-cheng-nsthread/" itemprop="url">
                  [转载]objective-C多线程NSThread
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-13T00:00:00+08:00">
              2013-09-13
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/13/zhuan-zai-objective-c-duo-xian-cheng-nsthread/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/13/zhuan-zai-objective-c-duo-xian-cheng-nsthread/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自：<a href="http://hi.baidu.com/wolf_childer/item/c9509eeae24b070965db00ae" target="_blank" rel="external">http://hi.baidu.com/wolf_childer/item/c9509eeae24b070965db00ae</a><br>iOS 支持多个层次的多线程编程，层次越高的抽象程度越高，使用起来也越方便，也是苹果最推荐使用的方法。下面根据抽象层次从低到高依次列出iOS所支持的多线程编程范式：<br><div id="content"></div></p>

<p>1, Thread;<br><br>2, Cocoa operations;<br><br>3, Grand Central Dispatch (GCD) (iOS4 才开始支持)</p>

<p><strong>下面简要说明这三种不同范式：</strong><br>Thread 是这三种范式里面相对轻量级的，但也是使用起来最负责的，你需要自己管理thread的生命周期，线程之间的同步。线程共享同一应用程序的部分内存空间，它们拥有对数据相同的访问权限。你得协调多个线程对同一数据的访问，一般做法是在访问之前加锁，这会导致一定的性能开销。在 iOS 中我们可以使用多种形式的 thread:<br><br>Cocoa threads: 使用NSThread 或直接从 NSObject 的类方法 performSelectorInBackground:withObject: 来创建一个线程。如果你选择thread来实现多线程，那么 NSThread 就是官方推荐优先选用的方式。<br><br>POSIX threads: 基于 C 语言的一个多线程库，</p>

<p>Cocoa operations是基于 Obective-C实现的，类 NSOperation 以面向对象的方式封装了用户需要执行的操作，我们只要聚焦于我们需要做的事情，而不必太操心线程的管理，同步等事情，因为NSOperation已经为我们封装了这些事情。 NSOperation 是一个抽象基类，我们必须使用它的子类。iOS 提供了两种默认实现：NSInvocationOperation 和 NSBlockOperation。</p>

<p>Grand Central Dispatch (GCD): iOS4 才开始支持，它提供了一些新的特性，以及运行库来支持多核并行编程，它的关注点更高：如何在多个 cpu 上提升效率。</p>

<p>有了上面的总体框架，我们就能清楚地知道不同方式所处的层次以及可能的效率，便利性差异。下面我们先来看看 NSThread 的使用，包括创建，启动，同步，通信等相关知识。这些与 win32/Java 下的 thread 使用非常相似。</p>

<p><strong>线程创建与启动</strong><br>NSThread的创建主要有两种直接方式：<br><br>[NSThread detachNewThreadSelector:@selector(myThreadMainMethod:) toTarget:self withObject:nil];<br><br>和<br>NSThread* myThread = [[NSThread alloc] initWithTarget:self<br><br>selector:@selector(myThreadMainMethod:)<br><br>object:nil];<br><br>[myThread start];</p>

<p>这两种方式的区别是：前一种一调用就会立即创建一个线程来做事情；而后一种虽然你 alloc 了也 init了，但是要直到我们手动调用 start 启动线程时才会真正去创建线程。这种延迟实现思想在很多跟资源相关的地方都有用到。后一种方式我们还可以在启动线程之前，对线程进行配置，比如设置 stack 大小，线程优先级。</p>

<p>还有一种间接的方式，更加方便，我们甚至不需要显式编写 NSThread 相关代码。那就是利用 NSObject 的类方法 performSelectorInBackground:withObject: 来创建一个线程：<br><br>[myObj performSelectorInBackground:@selector(myThreadMainMethod) withObject:nil];<br><br>其效果与 NSThread 的 detachNewThreadSelector:toTarget:withObject: 是一样的。</p>

<p><strong>线程同步</strong><br>线程的同步方法跟其他系统下类似，我们可以用原子操作，可以用 mutex，lock等。<br><br>iOS的原子操作函数是以 OSAtomic开头的，比如：OSAtomicAdd32, OSAtomicOr32等等。这些函数可以直接使用，因为它们是原子操作。</p>

<p>iOS中的 mutex 对应的是 NSLock，它遵循 NSLooking协议，我们可以使用 lock, tryLock, lockBeforeData:来加锁，用 unLock来解锁。使用示例：<br><br>BOOL moreToDo = YES;<br><br>NSLock <em>theLock = [[NSLock alloc] init];<br><br>…<br><br>while (moreToDo) {<br><br>/</em> Do another increment of calculation <em>/<br><br>/</em> until there’s no more to do. <em>/<br><br>if ([theLock tryLock]) {<br><br>/</em> Update display used by all threads. */<br><br>[theLock unlock];<br><br>}<br>}</p>

<p>我们可以使用指令 @synchronized 来简化 NSLock的使用，这样我们就不必显示编写创建NSLock,加锁并解锁相关代码。<br><br>- (void)myMethod:(id)anObj<br><br>{<br>@synchronized(anObj)<br><br>{<br>// Everything between the braces is protected by the @synchronized directive.<br><br>}<br>}</p>

<p>还有其他的一些锁对象，比如：循环锁NSRecursiveLock，条件锁NSConditionLock，分布式锁NSDistributedLock等等，在这里就不一一介绍了，大家去看官方文档吧。</p>

<p><strong>用NSCodition同步执行的顺序</strong><br>NSCodition 是一种特殊类型的锁，我们可以用它来同步操作执行的顺序。它与 mutex 的区别在于更加精准，等待某个 NSCondtion 的线程一直被 lock，直到其他线程给那个 condition 发送了信号。下面我们来看使用示例：</p>

<p>某个线程等待着事情去做，而有没有事情做是由其他线程通知它的。</p>

<p>[cocoaCondition lock];<br><br>while (timeToDoWork &lt;= 0)<br><br>[cocoaCondition wait];</p>

<p>timeToDoWork–;<br><br>// Do real work here.<br><br>[cocoaCondition unlock];</p>

<p>其他线程发送信号通知上面的线程可以做事情了：<br><br>[cocoaCondition lock];<br><br>timeToDoWork++;<br><br>[cocoaCondition signal];<br><br>[cocoaCondition unlock];</p>

<p><strong>线程间通信</strong><br>线程在运行过程中，可能需要与其它线程进行通信。我们可以使用 NSObject 中的一些方法：<br><br>在应用程序主线程中做事情：<br><br>performSelectorOnMainThread:withObject:waitUntilDone:<br><br>performSelectorOnMainThread:withObject:waitUntilDone:modes:</p>

<p>在指定线程中做事情：<br><br>performSelector:onThread:withObject:waitUntilDone:<br><br>performSelector:onThread:withObject:waitUntilDone:modes:</p>

<p>在当前线程中做事情：<br><br>performSelector:withObject:afterDelay:<br><br>performSelector:withObject:afterDelay:inModes:</p>

<p>取消发送给当前线程的某个消息<br><br>cancelPreviousPerformRequestsWithTarget:<br><br>cancelPreviousPerformRequestsWithTarget:selector:object:</p>

<p>如在我们在某个线程中下载数据，下载完成之后要通知主线程中更新界面等等，可以使用如下接口：- (void)myThreadMainMethod<br><br>{<br>NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];<br><br>// to do something in your thread job<br><br>…<br><br>[self performSelectorOnMainThread:@selector(updateUI) withObject:nil waitUntilDone:NO];<br><br>[pool release];<br><br>}</p>

<p><strong>RunLoop</strong><br>说到 NSThread 就不能不说起与之关系相当紧密的 NSRunLoop。Run loop 相当于 win32 里面的消息循环机制，它可以让你根据事件/消息（鼠标消息，键盘消息，计时器消息等）来调度线程是忙碌还是闲置。<br><br>系统会自动为应用程序的主线程生成一个与之对应的 run loop 来处理其消息循环。在触摸 UIView 时之所以能够激发 touchesBegan/touchesMoved 等等函数被调用，就是因为应用程序的主线程在 UIApplicationMain 里面有这样一个 run loop 在分发 input 或 timer 事件。</p>

<p></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/11/xin-qing-wo-de-meng-xiang-you-zhe-me-yi-liang-fang-che-ke-yi-ge-di-lv-you-le/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/11/xin-qing-wo-de-meng-xiang-you-zhe-me-yi-liang-fang-che-ke-yi-ge-di-lv-you-le/" itemprop="url">
                  [心情]我的梦想啊！有这么一辆房车可以各地旅游了！
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-11T00:00:00+08:00">
              2013-09-11
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/11/xin-qing-wo-de-meng-xiang-you-zhe-me-yi-liang-fang-che-ke-yi-ge-di-lv-you-le/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/11/xin-qing-wo-de-meng-xiang-you-zhe-me-yi-liang-fang-che-ke-yi-ge-di-lv-you-le/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><div id="post-content"><br>转载请参见文章末尾处的要求。<br><br>嗨！我是汉克，我买了一辆公交车。我受够了在建筑学院里，每天画一些子虚乌有的建筑，面对的都是假想的客户，对细节感到莫名其妙。我喜欢亲自动手工作，充分地探索细节，我很享受全心全意投入工作和原型设计里。所以我决定把一辆买来的辆校车变为一个小型居所，这个作为我的硕士毕业设计。能这样做多亏我有幸有个好导师，马库斯·亚当，他完全支持我允许我雄心勃勃地做这样一个很另类的项目。</div></p>

<p>公交车是在Craigslist上买的，花了三千美金，在改进它上面我又花掉大约六千美金。这并不是一笔小数目，但是比一个房子的首付要少，甚至比我最后一学期在研究生院的学费都少。完成整个工程的主体用了不到15周，正好赶上我的终期答辩（尽管前七周全都用在设计和原型上面，在最后一个月加上半个学期才完成了庞大的建造部分）。</p>

<p>这个不是最开始的目的，但是这个机会并没有充分利用好，我想告诉人们的是一辆交通工具可塑造的潜能。</p>

<p>我还觉得证明完全迭代在建筑工程教育中的价值非常重要。现在有很多建筑学院的学生不懂最基本的物质的物理限制还有它们组合的方式。这个项目主要是为了展示一个细节设计简单的小建筑比一个复杂的、注重难以理解的理论的建筑更有价值。我觉得在建筑学里我们应该更多地动手操作。</p>

<p>这个文章里有很多精彩的照片来丰富我们的旅行，但是这些照片并不能完全展现它全部的功能以及灵活性。这些图片详细阐述了怎样管理空间才能创造一个舒适、实用又灵活的环境。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/PLOT-3.jpg" width="810" height="304"></p>

<p>每个等距离的窗框把空间分成了一个个28英寸的单元，中间留下的通道也是28英寸宽。这些单元被分组合并成了现有的四个区：浴室，厨房，客厅和卧室。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/130803_181715_JE_2731.jpg" width="810" height="540"></p>

<p>在设计阶段，主要的目标之一是在225平方英尺的空间内，创建一个尽可能开放、无拘束的生活空间。为了达到这个目的，我自己给自己规定不在窗户的下边框加设任何家具或者装置。这就得以使空间保持连贯，而且可以从头一眼望到尾，即使坐着也可以。为了达到这个目的，我做了一个薄壁系统，把装置、绝缘材料、电器、照明和车内墙整合在一起，在使用中可以直接看到内部。天花板是压缩弯曲的三合板，地板是回收的篮球场地板，三分线那部分。</p>

<p><a title="巴士之旅" href="http://hankboughtabus.com/wp-content/uploads/2013/08/bustour03.gif" rel="external" target="_blank"><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/bustour03.gif" width="810" height="529"></a></p>

<p>很多的窗户也使这个小空间有了开阔的感觉。很多公交车在改装的时候会遮盖住一些窗户，这样就能隔离出一些隐私的空间。这样的结果就是会大量减少采光，也阻挡了全景的视觉效果，更别想再合适的位置加上储存太阳能的装置了。为了中和隔离和隐私的问题，可以在低层的墙上安装下拉的半透明隔离板，然后用把它升上去用磁铁固定。此外，在紧急逃生门位置上面开两个天窗，可以大大增加采光。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/130803_211130_JE_2785.jpg" width="810" height="540"></p>

<p>这个空间的照明全是用LED管状灯，装在门窗墙面和天花板接缝处。这些灯是根据时间控制的，当然光线昏暗的时候会触发开关。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/130803_182228_JE_2737.jpg" width="540" height="600"></p>

<p>为了改变居住人对这里仍有校车的感觉，进门的地方被移到了车尾部。进入车内，车主首先看到的就是浴室。在这个区域，通道的一边是墙围住的马桶。目前这个位置放着一个未用过的便携马桶，但是未来几年很可能被一个铅垂状的马桶替代。通道的另一边目前没有设置，以备后来开发。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/130803_182608_JE_2752.jpg" width="810" height="540"></p>

<p>厨房占了两个窗格，目前唯一的用处就是一个脚踏式的水槽。现在计划一个窗格放一个小冰柜，再装一个炉灶，目前我们在用的是一个制冷器和一个便携的液化气灶。橱柜的框架已经装好了，但是抽屉和外观都还没有处理过。现在他们用的是一个简洁美观的存储箱来存放货物和食物。</p>

<p><a title="巴士之旅" href="http://www.geekfan.net/wp-content/uploads/gif" rel="external" target="_blank"><img alt="!!!" src="http://www.geekfan.net/wp-content/uploads/gif" width="900" height="561"></a></p>

<p>座椅是最万能的家具之一，它占用了四个窗格，是这之中最大的。在中间部分，这个区域在通道的两边各有四个大座位。两个靠近厨房的座位占用了车轮的部分，所以椅子下面没有储存空间了。把这些折叠椅子都放下来，再拼上几个邻近的垫子，就能拼成一个大号的床。在通道往下的两边的座位可以升降来组成一个桌子可以用来吃饭或者办公。这样人们不用越过其他人就可以使四个人都有桌子用。最后那个椅子下面有一个带锁的储存空间。这个空间的灵活性可以应对很多特殊情况。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/bustour02.gif" width="810" height="536"></p>

<p>睡觉的地方包含了两个等宽的窄床，分别在通道的两边。每一张床下面都有抽屉面向座位的那一面还有嵌入的架子。为了适应不同的睡觉安排，左侧的床移动到中间的通道上，就可以拼成一个大号的床然后把第三个床垫放到腾出的空间上。这样大的空间最多可以睡六个成年人。</p>

<p><img alt="" src="http://hankboughtabus.com/wp-content/uploads/2013/08/130803_184336_JE_2779.jpg" width="810" height="540"></p>

<p>公交车的驾驶舱基本上没有动，除了多了一些电线。一个滑动的门板把驾驶舱和车内起居室分开，如果路上要和驾驶员说话，就可以把左边门打开。</p>

<p><a title="巴士之旅" href="http://www.geekfan.net/wp-content/uploads/900x600x130811_084143_JE_3056.jpg.pagespeed.ic_.wLwFbPVyxR.jpg" rel="external" target="_blank"><img alt="900x600x130811_084143_JE_3056.jpg.pagespeed.ic.wLwFbPVyxR" src="http://www.geekfan.net/wp-content/uploads/900x600x130811_084143_JE_3056.jpg.pagespeed.ic_.wLwFbPVyxR.jpg" width="900" height="600"></a></p>

<p>这一切的元素整合在一起，至少最终变成了一个旅行用的交通工具，如果不完全算是一个家的话。我正准备把这个项目做得更好，继续造出更多的实用的系统，还有把一些原件改进的可以多次利用，这样就可以更好地理解住在一个小空间里的感受，扩大讨论小面积居住的问题。</p>

<p>&nbsp;</p>

<p>原文链接： <a href="http://www.hankboughtabus.com/a-tour-of-the-bus/" target="_blank">Hank</a> 翻译： <a href="http://www.geekfan.net/" target="_blank" rel="external">极客范 </a>- <a href="http://www.geekfan.net/author/songrunning/" target="_blank" rel="external">宁殿下</a></p>

<p>译文链接： <a href="http://www.geekfan.net/3314/" target="_blank" rel="external">http://www.geekfan.net/3314/</a></p>

<p>[ 转载请保留原文出处、译者和译文链接。]</p>

<p></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/10/codejamqualification-round-2008-problem-b-train-timetable/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/10/codejamqualification-round-2008-problem-b-train-timetable/" itemprop="url">
                  [CodeJam]Qualification Round 2008 Problem B. Train Timetable
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-10T00:00:00+08:00">
              2013-09-10
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/10/codejamqualification-round-2008-problem-b-train-timetable/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/10/codejamqualification-round-2008-problem-b-train-timetable/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://code.google.com/codejam/contest/32013/dashboard#s=p1&amp;a=1" target="_blank" rel="external">http://code.google.com/codejam/contest/32013/dashboard#s=p1&amp;a=1</a></p>

<p>Problem</p>

<p>A train line has two stations on it, A and B. Trains can take trips from A to B or from B to A multiple times during a day. When a train arrives at B from A (or arrives at A from B), it needs a certain amount of time before it is ready to take the return journey - this is the<i>turnaround time</i>. For example, if a train arrives at 12:00 and the turnaround time is 0 minutes, it can leave immediately, at 12:00.</p>

<p>A train timetable specifies departure and arrival time of all trips between A and B. The train company needs to know how many trains have to start the day at A and B in order to make the timetable work: whenever a train is supposed to leave A or B, there must actually be one there ready to go. There are passing sections on the track, so trains don’t necessarily arrive in the same order that they leave. Trains may not travel on trips that do not appear on the schedule.</p>

<p>Input</p>

<p>&nbsp;</p>

<p>The first line of input gives the number of cases, <b>N</b>. <b>N</b> test cases follow.</p>

<p>&nbsp;</p>

<p>Each case contains a number of lines. The first line is the turnaround time, <b>T</b>, in minutes. The next line has two numbers on it, <b>NA</b> and <b>NB</b>. <b>NA</b> is the number of trips from A to B, and <b>NB</b> is the number of trips from B to A. Then there are <b>NA</b> lines giving the details of the trips from A to B.</p>

<p>&nbsp;</p>

<p>Each line contains two fields, giving the HH:MM departure and arrival time for that trip. The departure time for each trip will be earlier than the arrival time. All arrivals and departures occur on the same day. The trips may appear in any order - they are not necessarily sorted by time. The hour and minute values are both two digits, zero-padded, and are on a 24-hour clock (00:00 through 23:59).</p>

<p>&nbsp;</p>

<p>After these <b>NA</b> lines, there are <b>NB</b> lines giving the departure and arrival times for the trips from B to A.</p>

<p>&nbsp;</p>

<p>Output</p>

<p>For each test case, output one line containing “Case #<b>x</b>: “ followed by the number of trains that must start at A and the number of trains that must start at B.</p>

<p>&nbsp;</p>

<p>Limits</p>

<p>1 ≤ <b>N</b> ≤ 100</p>

<p>Small dataset</p>

<p>0 ≤ <b>NA</b>, <b>NB</b> ≤ 20</p>

<p>0 ≤ <b>T</b> ≤ 5</p>

<p>Large dataset</p>

<p>0 ≤ <b>NA</b>, <b>NB</b> ≤ 100</p>

<p>0 ≤ <b>T</b> ≤ 60</p>

<p>Sample<br><div><br><table><br><tbody><br><tr><br><td>Input</td><br><td>Output</td><br></tr><br><tr><br><td><code><code>2<br><br>5<br>3 2<br><br>09:00 12:00<br><br>10:00 13:00<br><br>11:00 12:30<br><br>12:02 15:00<br><br>09:00 10:30<br><br>2<br>2 0<br><br>09:00 09:01<br><br>12:00 12:02</code></code>&nbsp;</td><br><td><code><code>Case #1: 2 2<br><br>Case #2: 2 0</code></code>&nbsp;</td><br></tr><br></tbody><br></table><br>&nbsp;</div></p>

<p>This problem can be solved with a greedy strategy. The simplest way to do this is by scanning through a list of all the trips, sorted by departure time, and keeping track of the set of trains that will be available at each station, and when they will be ready to take a trip.</p>

<p>When we examine a trip, we see if there will be a train ready at the departure station by the departure time. If there is, then we remove that train from the list of available trains. If there is not, then our solution will need one new train added for the departure station. Then we compute when the train taking this trip will be ready at the other station for another trip, and add this train to the set of available trains at the other station. If a train leaves station A at 12:00 and arrives at station B at 13:00, with a 5-minute turnaround time, it will be available for a return journey from B to A at 13:05.</p>

<p>We need to be able to efficiently identify the earliest a train can leave from a station; and update this set of available trains by adding new trains or removing the earliest train. This can be done using a heap data structure for each station.</p>

<p>Sample Python code provided below that solves a test case for this problem:<br><pre lang="python" colla="+">def SolveCase(case_index, case):<br>  T, (tripsa, tripsb) = case<br>  trips = []<br>  for trip in tripsa:<br>    trips.append([trip[0], trip[1], 0])<br>  for trip in tripsb:<br>    trips.append([trip[0], trip[1], 1])</pre></p>

<p>  trips.sort()</p>

<p>  start = [0, 0]<br><br>  trains = [[], []]</p>

<p>  for trip in trips:<br><br>    d = trip[2]<br><br>    if trains[d] and trains[d][0] &lt;= trip[0]:<br><br>      # We’re using the earliest train available, and<br><br>      # we have to delete it from this station’s trains.<br><br>      heappop(trains[d])<br><br>    else:<br><br>      # No train was available for the current trip,<br><br>      # so we’re adding one.<br><br>      start[d] += 1<br><br>    # We add an available train in the arriving station at the<br><br>    # time of arrival plus the turnaround time.<br><br>    heappush(trains[1 - d], trip[1] + T)</p>

<p>  print “Case #%d: %d %d” % (case_index, start[0], start[1])<br><br>Luckily Python has methods that implement the heap data structure operations. This solution takes O(n log n) time, where n is the total number of trips, because at each trip we do at most one insert or one delete operation from the heaps, and heap operations take O(log n) time.</p>

<p></p>

<p><pre lang="cpp" colla="+"></pre></p>

<p>//<br><br>//  main.cpp<br><br>//  CodeJamProject<br><br>//<br><br>//  Created by Jiang, Nan on 8/26/13.<br><br>//  Copyright (c) 2013 Jiang, Nan. All rights reserved.<br><br>//</p>

<p>//#include <iostream><br>#include <stdio.h><br>#include <map><br>#include <vector><br>using namespace std;</vector></map></stdio.h></iostream></p>

<p>struct Trip{<br><br>    int startTime;<br><br>    int arriveTime;<br><br>    int from;<br><br>};</p>

<p>bool sortByMe(Trip&amp; t1, Trip&amp; t2){<br><br>    return t1.startTime &lt; t2.startTime;<br><br>}</p>

<p>int main(int argc, const char <em> argv[])<br><br>{<br>    freopen(“/Users/jiangnan/Develop/Code Jam/2008/CodeJamProject/CodeJamProject/B-large-practice.in.txt”, “r”, stdin);<br><br>    freopen(“/Users/jiangnan/Develop/Code Jam/2008/CodeJamProject/CodeJamProject/B-large-practice.out.txt”, “w”, stdout);<br><br>    <br><br>    int numCase;<br><br>    scanf(“%d”, &amp;numCase);<br><br>    for (int c = 0; c &lt; numCase; c++) {<br><br>        int t = 0, na = 0, nb = 0;<br><br>        scanf(“%d”, &amp;t);<br><br>        scanf(“%d %d”, &amp;na, &amp;nb);<br><br>        vector<trip> trips;<br><br>        for (int i = 0; i &lt; na + nb; i++) {<br><br>            int hh = 0, mm = 0;<br><br>            scanf(“%d:%d”, &amp;hh, &amp;mm);<br><br>            int start = hh </trip></em> 60 + mm;<br><br>            scanf(“%d:%d”, &amp;hh, &amp;mm);<br><br>            int end = hh * 60 + mm;<br><br>            Trip trip;<br><br>            trip.startTime = start;<br><br>            trip.arriveTime = end;<br><br>            if (i &lt; na) {<br><br>                trip.from = 0;<br><br>            }else{<br><br>                trip.from = 1;<br><br>            }<br><br>            trips.push_back(trip);<br><br>        }<br><br>        <br><br>        sort(trips.begin(), trips.end(), sortByMe);<br><br>        vector<int> trainsA;<br><br>        vector<int> trainsB;</int></int></p>

<p>        int countA = 0, countB = 0;<br><br>        <br><br>        for (int i = 0; i &lt; na + nb; i++) {<br><br>            Trip trip = trips[i];<br><br>            if (trip.from == 0) {<br><br>                if (trainsA.size() == 0) {<br><br>                    countA++;<br><br>                }else{<br><br>                    bool found = false;<br><br>                    vector<int>::iterator iter = trainsA.begin();<br><br>                    for (; iter != trainsA.end(); iter++) {<br><br>                        if (<em>iter &lt;= trip.startTime) {<br><br>                            trainsA.erase(iter);<br><br>                            found = true;<br><br>                            break;<br><br>                        }<br><br>                    }<br><br>                    if (found == false) {<br><br>                        countA++;<br><br>                    }<br><br>                }<br><br>                trainsB.push_back(trip.arriveTime + t);<br><br>            }else{<br><br>                if (trainsB.size() == 0) {<br><br>                    countB++;<br><br>                }else{<br><br>                    bool found = false;<br><br>                    vector<int>::iterator iter = trainsB.begin();<br><br>                    for (; iter != trainsB.end(); iter++) {<br><br>                        if (</int></em>iter &lt;= trip.startTime) {<br><br>                            trainsB.erase(iter);<br><br>                            found = true;<br><br>                            break;<br><br>                        }<br><br>                    }<br><br>                    if (found == false) {<br><br>                        countB++;<br><br>                    }<br><br>                }<br><br>                trainsA.push_back(trip.arriveTime + t);<br><br>            }<br><br>        }<br><br>        <br><br>        printf(“Case #%d: %d %d\n”, c+1, countA, countB);<br><br>    }<br><br>    <br><br>    fclose(stdin);<br><br>    fclose(stdout);<br><br>    return 0;<br><br>}<br></int></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/09/codejamqualification-round-2008-problem-a-saving-the-universe/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/09/codejamqualification-round-2008-problem-a-saving-the-universe/" itemprop="url">
                  [CodeJam]Qualification Round 2008 Problem A. Saving the Universe
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-09T00:00:00+08:00">
              2013-09-09
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/09/codejamqualification-round-2008-problem-a-saving-the-universe/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/09/codejamqualification-round-2008-problem-a-saving-the-universe/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a title="http://code.google.com/codejam/contest/32013/dashboard#s=p0&amp;a=0" href="http://code.google.com/codejam/contest/32013/dashboard#s=p0&amp;a=0" target="_blank" rel="external">http://code.google.com/codejam/contest/32013/dashboard#s=p0&amp;a=0</a></p>

<p>Problem</p>

<p>The urban legend goes that if you go to the Google homepage and search for “Google”, the universe will implode. We have a secret to share… It is true! Please don’t try it, or tell anyone. All right, maybe not. We are just kidding.</p>

<p>The same is not true for a universe far far away. In that universe, if you search on any search engine for that search engine’s name, the universe does implode!</p>

<p>To combat this, people came up with an interesting solution. All queries are pooled together. They are passed to a central system that decides which query goes to which search engine. The central system sends a series of queries to one search engine, and can switch to another at any time. Queries must be processed in the order they’re received. The central system must never send a query to a search engine whose name matches the query. In order to reduce costs, the number of switches should be minimized.</p>

<p>Your task is to tell us how many times the central system will have to switch between search engines, assuming that we program it optimally.</p>

<p>Input</p>

<p>The first line of the input file contains the number of cases, <b>N</b>. <b>N</b> test cases follow.</p>

<p>Each case starts with the number <b>S</b> – the number of search engines. The next <b>S</b> lines each contain the name of a search engine. Each search engine name is no more than one hundred characters long and contains only uppercase letters, lowercase letters, spaces, and numbers. There will not be two search engines with the same name.</p>

<p>The following line contains a number <b>Q</b> – the number of incoming queries. The next <b>Q</b>lines will each contain a query. Each query will be the name of a search engine in the case.</p>

<p>Output</p>

<p>For each input case, you should output:<br><pre>Case #<b>X</b>: <b>Y</b></pre><br>where <b>X</b> is the number of the test case and <b>Y</b> is the number of search engine switches. Do not count the initial choice of a search engine as a switch.</p>

<p>&nbsp;</p>

<p>Limits</p>

<p>0 &lt; <b>N</b> ≤ 20</p>

<p>Small dataset</p>

<p>2 ≤ <b>S</b> ≤ 10</p>

<p>0 ≤ <b>Q</b> ≤ 100</p>

<p>Large dataset</p>

<p>2 ≤ <b>S</b> ≤ 100</p>

<p>0 ≤ <b>Q</b> ≤ 1000</p>

<p>Sample<br><div><br><table><br><tbody><br><tr><br><td><br>Input</td><br><td><br>Output</td><br></tr><br><tr><br><td><code>2<br><br>5<br>Yeehaw<br><br>NSM<br><br>Dont Ask<br><br>B9<br><br>Googol<br><br>10<br><br>Yeehaw<br><br>Yeehaw<br><br>Googol<br><br>B9<br><br>Googol<br><br>NSM<br><br>B9<br><br>NSM<br><br>Dont Ask<br><br>Googol<br><br>5<br>Yeehaw<br><br>NSM<br><br>Dont Ask<br><br>B9<br><br>Googol<br><br>7<br>Googol<br><br>Dont Ask<br><br>NSM<br><br>NSM<br><br>Yeehaw<br><br>Yeehaw<br><br>Googol</code></td></tr></tbody></table></div></p>

<p><br><td><code>Case #1: 1<br><br>Case #2: 0</code></td></p>

<p><br><br><br><br><br>In the first case, one possible solution is to start by using Dont Ask, and switch to NSM after query number 8.<br><br>For the second case, you can use B9, and not need to make any switches.</p>

<p><strong>[Analysis]</strong><br>The first task in the new Google Code Jam is about, no surprise, search engines, and also, the grandiose feat of saving the universe in a parsimonious way. However, putting all the fancies aside, the problem itself is easy.</p>

<p>List all queries one by one, and break them up into segments. Each segment will be an interval where we use one search engine, and when we cross from one segment to another we will switch the search engine we use. What can you say about each segment? Well, one thing for sure is:</p>

<p>Never ever ever have all S different search engines appear as queries in one segment. (<em>)<br><br>Why is this? Because if all S names appeared in one segment, then any search engine used for that segment will encounter at least one query that is the same as its name, thus exploding the universe!<br><br>Working in the opposite direction, (</em>) is all we need to achieve; as long as you can partition the list of queries into such segments, it corresponds to a plan of saving the universe. You don’t even care about which engine is used for one segment; any engine not appearing as a query on that segment will do. However, you might sometimes pick the same engine for two consecutive segments, laughing at yourself when you realize it; why don’t I just join the two segments into one? Because your task is to use as few segments as possible, it is obvious that you want to make each segment as long as possible.</p>

<p>This leads to the greedy solution: Starting from the first query, add one query at a time to the current segment until the names of all S search engines have been encountered. Then we continue this process in a new segment until all queries are processed.</p>

<p>Sample code in C++, where st is the set of queries in the current segment, q is the next query, and count is the number of switches.</p>

<p>st.clear();<br><br>count = 0;<br><br>for (int i=0; i&lt;Q; i++) {<br><br>getline(cin, q);<br><br>if (st.find(q) == st.end()) {<br><br>if (st.size() == S-1) {<br><br>st.clear();<br><br>count++;<br><br>}<br>st.insert(q);<br><br>}<br>}<br><br>If st is a hashset, you expect the solution run in O(n) time. Note that this solution uses the fact that each query will be a search engine name and so we can ignore the list of names provided in the input.<br><br>Let us justify that the greedy approach always gives the optimal answer. Think of the procedure as Q steps, and we want to show that, for each i, there is (at least) one optimal choice which agrees with us on the first i steps. We do this inductively for i = 0, then i = 1, and so on. The proposition for i = Q when proven true will imply that our algorithm is correct.</p>

<p>So, the key points in the inductive step i:<br><br>If adding the next query will explode the universe, we must start a new segment. Any optimal choice agrees with us for the first (i-1) steps must also do that.<br><br>If adding the next query will not explode the universe, we do not start a new segment. We know there is an optimal solution R agreed with us for (i-1) steps. Even if in R a new segment is started at step i, we can modify it a little bit. Let R’ be the plan that agrees with R, but instead of starting a new segment on the i-th step, we delay this to the (i+1)st. It is clear that R’ will also make the universe safe, and has no more switches than R does. So, R’ is also an optimal solution, and agrees with our choice for the first i steps.<br><br>The similar lines of justifications work for many greedy algorithms, including the well beloved minimum spanning trees.<br><pre lang="cpp">// CodeJamPratice.cpp : Defines the entry point for the console application.<br>//</pre></p>

<p>#include “stdafx.h”<br><br>#include <br><br>#include <br><br>#include <br><br>#include <br><br>#include <br><br>#include <br><br>using namespace std;</p>

<p>int _tmain(int argc, _TCHAR* argv[])<br><br>{<br>    freopen(“../debug/A-large-practice.in”, “r”, stdin);<br><br>    freopen(“../debug/A-large-practice.out”, “w”, stdout);</p>

<p>    int numCase;<br><br>    scanf(“%d”, &amp;numCase);<br><br>    for(int c = 0; c &lt; numCase; c++)<br><br>    {<br><br>        int engineCount = 0;<br><br>        scanf(“%d”, &amp;engineCount);</p>

<p>        vector engines;</p>

<p>        char tmp[100] = {0};<br><br>        gets(tmp);<br><br>        for(int i = 0; i &lt; engineCount; i++)<br><br>        {<br><br>            gets(tmp);<br><br>            string str = string(tmp);<br><br>            engines.push_back(str);<br><br>        }</p>

<p>        vector st;<br><br>        int count = 0;<br><br>        int queueSize = 0;<br><br>        scanf(“%d”, &amp;queueSize);<br><br>        gets(tmp);<br><br>        for(int i = 0; i &lt; queueSize; i++)<br><br>        {<br><br>            char tmp[100] = {0};<br><br>            gets(tmp);<br><br>            string str = string(tmp);<br><br>            vector::iterator iter = st.begin();</p>

<p>            bool found = false;<br><br>            for(; iter != st.end(); iter++)<br><br>            {<br><br>                if(iter-&gt;compare(str) == 0)<br><br>                    found = true;<br><br>            }</p>

<p>            if(found == false)<br><br>            {<br><br>                if(st.size() == engineCount - 1)<br><br>                {<br><br>                    st.clear();<br><br>                    count++;<br><br>                }<br><br>                st.push_back(str);<br><br>            }<br><br>        }</p>

<p>        printf(“Case #%d: %d\n”, c+1, count);<br><br>    }</p>

<p>    fclose(stdin);<br><br>    fclose(stdout);<br><br>    return 0;<br><br>}</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/04/ios-guan-yu-shi-xian-ios7-shang-mian-blur-xiao-guo-de-shi-xian/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/04/ios-guan-yu-shi-xian-ios7-shang-mian-blur-xiao-guo-de-shi-xian/" itemprop="url">
                  [原创][iOS]关于实现iOS7上面Blur效果的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-04T00:00:00+08:00">
              2013-09-04
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/04/ios-guan-yu-shi-xian-ios7-shang-mian-blur-xiao-guo-de-shi-xian/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/04/ios-guan-yu-shi-xian-ios7-shang-mian-blur-xiao-guo-de-shi-xian/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前几个月iOS7发布，说实话界面扁平化，个人不是很喜欢，但是它的一些效果还是比较炫的，比如Blur效果，看下图<br><a href="http://www.njiang1987.com/wp-content/uploads/2013/09/photo1_normal.png" target="_blank" rel="external"><img src="http://www.njiang1987.com/wp-content/uploads/2013/09/photo1_normal-169x300.png" alt="photo1_normal" width="169" height="300" class="alignnone size-medium wp-image-43"></a>  <a href="http://www.njiang1987.com/wp-content/uploads/2013/09/photo2_normal.png" target="_blank" rel="external"><img src="http://www.njiang1987.com/wp-content/uploads/2013/09/photo2_normal-169x300.png" alt="photo2_normal" width="169" height="300" class="alignnone size-medium wp-image-44"></a><br>右边的图片，有个Blur效果，最近PM正想将这个效果添加到我们的产品中，查看网上说，苹果是通过直接从GPU里面取出图片信息，然后render出来的，也没有公用的API可以调用。不过有类似的方法可以模拟这个效果，比如Gaussian Blur，这个是通过CoreImage.framework里面的CIFilter实现的，具体实现如下：<br><pre lang="objc" colla="+"><br>CGImageRef imageRef = CGImageCreateWithImageInRect(image.CGImage, frame);<br><br>CIImage <em>imageToBlur = [CIImage imageWithCGImage:imageRef];<br>CIFilter </em>blurFilter = [CIFilter filterWithName:@”CIGaussianBlur”];<br>[blurFilter setValue:imageToBlur forKey:@”inputImage”];<br>[blurFilter setValue:[NSNumber numberWithFloat:0.1f] forKey:@”inputRadius”];<br>CIImage<em> result = [blurFilter valueForKey:@”outputImage”];<br><br>CIContext</em> context = [CIContext contextWithOptions:nil];<br>CGImageRef cgImage = [context createCGImage:result fromRect:[imageToBlur extent]];<br><br>UIImage* newImage = [UIImage imageWithCGImage:cgImage];<br></pre><br>这样就可以得到一个模糊的效果。但是这种模糊有2个缺点：<br><br>1.如果设置的半径比较大，效率会很低<br><br>2.模糊以后的效果不好</p>

<p>后来在网上查到可以用boxblur算法，这个会用到Accelerate.framework里面的一个函数vImageBoxConvolve_ARGB8888，具体实现如下：<br><pre lang="objc" colla="+"><br>- (UIImage<em>)imageWithBoxBlur:(CGFloat)blur withBoxSize:(int)iSize<br>{<br>    if (blur &lt; 0.f || blur &gt; 1.f) {<br>        blur = 0.5f;<br>    }<br>    int boxSize = (int)(blur </em> iSize);<br>    boxSize = boxSize - (boxSize % 2) + 1;</pre></p>

<p>    CGImageRef img = self.CGImage;<br><br>    vImage_Buffer inBuffer, outBuffer;<br><br>    vImage_Error error;<br><br>    void *pixelBuffer;</p>

<p>    //create vImage_Buffer with data from CGImageRef<br><br>    CGDataProviderRef inProvider = CGImageGetDataProvider(img);<br><br>    CFDataRef inBitmapData = CGDataProviderCopyData(inProvider);</p>

<p>    inBuffer.width = CGImageGetWidth(img);<br><br>    inBuffer.height = CGImageGetHeight(img);<br><br>    inBuffer.rowBytes = CGImageGetBytesPerRow(img);</p>

<p>    inBuffer.data = (void*)CFDataGetBytePtr(inBitmapData);</p>

<p>    //create vImage_Buffer for output<br><br>    pixelBuffer = malloc(CGImageGetBytesPerRow(img) * CGImageGetHeight(img));</p>

<p>    if(pixelBuffer == NULL)<br><br>        NSLog(@”No pixelbuffer”);</p>

<p>    outBuffer.data = pixelBuffer;<br><br>    outBuffer.width = CGImageGetWidth(img);<br><br>    outBuffer.height = CGImageGetHeight(img);<br><br>    outBuffer.rowBytes = CGImageGetBytesPerRow(img);</p>

<p>    //perform convolution<br><br>    error = vImageBoxConvolve_ARGB8888(&amp;inBuffer, &amp;outBuffer, NULL, 0, 0, boxSize, boxSize, NULL, kvImageEdgeExtend);</p>

<p>    if (error) {<br><br>        NSLog(@”error from convolution %ld”, error);<br><br>    }</p>

<p>    CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();<br><br>    CGContextRef ctx = CGBitmapContextCreate(outBuffer.data,<br><br>                                             outBuffer.width,<br><br>                                             outBuffer.height,<br><br>                                             8,<br><br>                                             outBuffer.rowBytes,<br><br>                                             colorSpace,<br><br>                                             (CGBitmapInfo)kCGImageAlphaNoneSkipLast);<br><br>    CGImageRef imageRef = CGBitmapContextCreateImage (ctx);<br><br>    UIImage *returnImage = [UIImage imageWithCGImage:imageRef];</p>

<p>    //clean up<br><br>    CGContextRelease(ctx);<br><br>    CGColorSpaceRelease(colorSpace);</p>

<p>    free(pixelBuffer);<br><br>    //free(pixelBuffer2);<br><br>    CFRelease(inBitmapData);</p>

<p>    CGColorSpaceRelease(colorSpace);<br><br>    CGImageRelease(imageRef);</p>

<p>    return returnImage;<br><br>}<br><br>这个boxblur有个2个优点：<br><br>1. 速度很快<br><br>2. 模糊以后的效果很好<br><br>正好弥补了Gaussian Blur的缺点，但是这个boxblur也有个致命的缺点就是，如果一张图片既有深色区域又有浅色区域，模糊以后，深色区域的颜色就不对了。过几天我再来补图。<br><br>后来无意中发现，如果先用Gaussian blur以后，再用boxblur几次，效果比较好。还是过几天来补图，呵呵，这几天比较忙，一直在做PM的Spec，虽然都是界面的东西，对我一个计算机半路出家的人来说还是优点难度的。以下是效果图，外加公司的产品。<br><br>[caption id=”attachment_48” align=”aligncenter” width=”300”]<a href="http://www.njiang1987.com/wp-content/uploads/2013/09/iOS-Simulator-Screen-shot-Sep-4-2013-7.43.34-PM.png" target="_blank" rel="external"><img src="http://www.njiang1987.com/wp-content/uploads/2013/09/iOS-Simulator-Screen-shot-Sep-4-2013-7.43.34-PM-300x225.png" alt="blur以后的效果图" width="300" height="225" class="size-medium wp-image-48"></a> blur以后的效果图[/caption]</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/04/ios-guan-yu-calayer-he-uiview-animation-tong-bu-wen-ti/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/04/ios-guan-yu-calayer-he-uiview-animation-tong-bu-wen-ti/" itemprop="url">
                  [iOS]关于CALayer和UIView Animation同步问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-04T00:00:00+08:00">
              2013-09-04
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/04/ios-guan-yu-calayer-he-uiview-animation-tong-bu-wen-ti/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/04/ios-guan-yu-calayer-he-uiview-animation-tong-bu-wen-ti/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在做项目的时候, 同时用到了CABasicAnimation和UIView的animation， 发现会有问题，calayer的animation和uiview的animation不同步，比如CALayer设置position的animation<br><pre lang="objc" colla="+">CABasicAnimation* animation = [CABasicAnimation animationWithKeyPath:@”position”];<br>animation.fromValue = [NSValue valueWithCGPoint:startpoint];<br>animation.toValue = [NSValue valueWithCGPoint:endpoint];<br>animation.duration = INFO_WINDOW_SLIDE_ANIMATION_TIME;<br>animation.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn];<br>[blurredLayer addAnimation:animation forKey:@”appear”];<br></pre></p>

<p>UIView 的animation：<br><pre lang="objc" colla="+">backgroundView.frame = startframe;<br>[UIView animateWithDuration:INFO_WINDOW_SLIDE_ANIMATION_TIME delay:0 options:UIViewAnimationOptionCurveEaseIn animations:^{<br>        backgroundView.frame = endframe;<br>} completion:NULL];<br></pre><br>blurredLayer会抖动。后来再stackoverflow上面找到解决方法是将CALayer的animation换成<br><pre lang="objc" colla="+"><br>blurredLayer.position = startpoint;<br>[CATransaction begin];<br>[CATransaction setAnimationDuration:INFO_WINDOW_SLIDE_ANIMATION_TIME];<br>[CATransaction setAnimationTimingFunction:[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn]];<br>blurredLayer.position = endpoint;<br>[CATransaction commit];<br></pre><br>这样两个animation就同步了，具体原因不详。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/04/codejamproblem-a-alien-numbers/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/04/codejamproblem-a-alien-numbers/" itemprop="url">
                  [CodeJam]Problem A. Alien Numbers
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-04T00:00:00+08:00">
              2013-09-04
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/04/codejamproblem-a-alien-numbers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/04/codejamproblem-a-alien-numbers/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a title="http://code.google.com/codejam/contest/32003/dashboard" href="http://code.google.com/codejam/contest/32003/dashboard" target="_blank" rel="external">http://code.google.com/codejam/contest/32003/dashboard</a></p>

<p>Problem</p>

<p>The decimal numeral system is composed of ten digits, which we represent as “0123456789” (the digits in a system are written from lowest to highest). Imagine you have discovered an alien numeral system composed of some number of digits, which may or may not be the same as those used in decimal. For example, if the alien numeral system were represented as “oF8”, then the numbers one through ten would be (F, 8, Fo, FF, F8, 8o, 8F, 88, Foo, FoF). We would like to be able to work with numbers in arbitrary alien systems. More generally, we want to be able to convert an arbitrary number that’s written in one alien system into a second alien system.</p>

<p>Input</p>

<p>The first line of input gives the number of cases, <b>N</b>. <b>N</b> test cases follow. Each case is a line formatted as<br><pre>alien_number source_language target<em>language</em></pre><br>Each language will be represented by a list of its digits, ordered from lowest to highest value. No digit will be repeated in any representation, all digits in the alien number will be present in the source language, and the first digit of the alien number will not be the lowest valued digit of the source language (in other words, the alien numbers have no leading zeroes). Each digit will either be a number 0-9, an uppercase or lowercase letter, or one of the following symbols <code>!”#$%&amp;’()*+,-./:;&lt;=&gt;?@[]^`{|}~</code></p>

<p>Output</p>

<p>For each test case, output one line containing “Case #<b>x</b>: “ followed by the alien number translated from the source language to the target language.</p>

<p>Limits</p>

<p>1 ≤ <b>N</b> ≤ 100.</p>

<p>Small dataset</p>

<p>1 ≤ num digits in <b>alien_number</b> ≤ 4,<br><br>2 ≤ num digits in <b>source_language</b> ≤ 16,<br><br>2 ≤ num digits in <b>target_language</b> ≤ 16.</p>

<p>Large dataset</p>

<p>1 ≤ <b>alien_number</b> (in decimal) ≤ 1000000000,<br><br>2 ≤ num digits in <b>source_language</b> ≤ 94,<br><br>2 ≤ num digits in <b>target_language</b> ≤ 94.</p>

<p>Sample<br><div><br><table><br><tbody><br><tr><br><td>Input</td><br><td>Output</td><br></tr><br><tr><br><td><code><code>4<br><br>9 0123456789 oF8<br><br>Foo oF8 0123456789<br><br>13 0123456789abcdef 01<br><br>CODE O!CDE? A?JM!.</code></code>&nbsp;</td><br><td><code>Case #1: Foo<br><br>Case #2: 9<br><br>Case #3: 10011<br><br>Case #4: JAM!<br></code></td><br></tr><br></tbody><br></table><br></div></p>

<p>这个题可以简单的理解为从一个n进制的数转换为m进制的数，n进制、m进制跟10进制的唯一区别就是所用的表达符号不一样了，其实转换的道理是一样的，如果上过计算机的课程应该都知道10进制、2进制、16进制相互转化的过程的，n进制数直接转m进制数不好转，我们可以先将n进制的奇怪符号转换成10进制，再将10进制转换成m进制的奇怪符号，就这样。以下是源程序，直接贴代码了，注视的化以后等有时间再加吧，累。。。。。。。。。。。。。。。。。。</p>

<p><pre lang="cpp"><br>//<br>//  main.cpp<br>//  CodeJamProject<br>//<br>//  Created by Jiang, Nan on 8/26/13.<br>//  Copyright (c) 2013 Jiang, Nan. All rights reserved.<br>//</pre></p>

<p>//#include <br><br>#include <br><br>#include<br><map><br>#include </map><br><br>using namespace std;</p>

<p>int main(int argc, const char * argv[])<br><br>{<br>    freopen(“/Users/jiangnan/Develop/Code Jam/2008/CodeJamProject/CodeJamProject/A-large-practice.in.txt”, “r”, stdin);<br><br>    freopen(“/Users/jiangnan/Develop/Code Jam/2008/CodeJamProject/CodeJamProject/A-large-practice.out.txt”, “w”, stdout);</p>

<p>    int numCase;<br><br>    scanf(“%d”, &amp;numCase);<br><br>    for (int c = 0; c &lt; numCase; c++) {<br><br>        char number[100] = {0};<br><br>        char source[100] = {0};<br><br>        char target[100] = {0};<br><br>        scanf(“%s %s %s”, number, source, target);<br><br>        int srcSize = 0, tarSize = 0;<br><br>        map&lt;char, int&gt; srcmap;<br><br>        map&lt;char, int&gt; tarmap;<br><br>        int i = 0;<br><br>        while (source[i] != ‘\0’) {<br><br>            srcmap[source[i]] = i;<br><br>            i++;<br><br>        }<br><br>        srcSize = i;<br><br>        i = 0;<br><br>        while (target[i] != ‘\0’) {<br><br>            tarmap[target[i]] = i;<br><br>            i++;<br><br>        }<br><br>        tarSize = i;<br><br>        int decimal = 0;<br><br>        i = 100;<br><br>        while (number[i] == ‘\0’) {<br><br>            i–;<br><br>        }<br><br>        int k = 1;<br><br>        while (i &gt; -1) {<br><br>            decimal += k <em> srcmap[number[i]];<br><br>            k </em>= srcSize;<br><br>            i–;<br><br>        }<br><br>        i = 0;<br><br>        char tarnum[100] = {0};<br><br>        while (decimal != 0) {<br><br>            int t = decimal % tarSize;<br><br>            tarnum[i] = target[t];<br><br>            decimal = (decimal - t) / tarSize;<br><br>            i++;<br><br>        }<br><br>        int start = 0, end = i-1;<br><br>        while (start &lt;= end) {<br><br>            char t = tarnum[start];<br><br>            tarnum[start] = tarnum[end];<br><br>            tarnum[end] = t;<br><br>            start++;<br><br>            end–;<br><br>        }</p>

<p>        printf(“Case #%d: %s\n”, c+1, tarnum);<br><br>    }</p>

<p>    fclose(stdin);<br><br>    fclose(stdout);<br><br>    return 0;<br><br>}<br></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.njiang.cn/2013/09/02/guan-yu-zen-yao-yong-instrumentcha-kan-object-retainqing-kuang/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="姜楠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="天空の城">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="天空の城" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/09/02/guan-yu-zen-yao-yong-instrumentcha-kan-object-retainqing-kuang/" itemprop="url">
                  关于怎么用Instrument查看object retain情况
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-09-02T13:53:06+08:00">
              2013-09-02
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-12-26T16:40:34+08:00">
              2016-12-26
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2013/09/02/guan-yu-zen-yao-yong-instrumentcha-kan-object-retainqing-kuang/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/09/02/guan-yu-zen-yao-yong-instrumentcha-kan-object-retainqing-kuang/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>You can use the Allocations instrument to track the lifecycle of your objects. If you use the “Allocations” template, it is configured to record malloc and free events. You may want to configure it to also record retain, release, and autorelease events by turning on the “Record reference counts” checkbox in the Allocations instrument settings:</p>
<p><img alt="record reference counts checkbox" src="http://i.stack.imgur.com/SotDR.png"></p>
<p>(You cannot toggle this while Instruments is recording, which it starts by default as soon as you choose your template.)</p>
<p>After your run, you can find your objects using the Allocations &gt; Statistics &gt; Object Summary view, which is the default setting for the Detail pane (the bottom half of the window):</p>
<p><img alt="Object Summary setting for Detail pane" src="http://i.stack.imgur.com/08ued.png"></p>
<p>If you want to see objects that had been deallocated before you stopped the run, you need to change the Allocation Lifespan setting from “Created &amp; Still Living” (the default) to “All Objects Created”:</p>
<p><img alt="Allocation Lifespan setting" src="http://i.stack.imgur.com/4SVf2.png"></p>
<p>To find objects of a specific class, start by typing the class name into the Search field at the right end of the window toolbar. Then find the class name in the Category column of the list view, mouse over it, and click the arrow that appears next to it. For example, my app has a class named Tile, so I search for that and then click the arrow next to Tile in the list view:</p>
<p><img alt="Searching" src="http://i.stack.imgur.com/GtLnh.gif"></p>
<p>Now the list view shows every instance of Tile. (Note that you have to enter the actual class of the object, not a superclass. Entering NSObject will only find objects that were created by [NSObject alloc], not objects that were created by [Tile alloc].) I can see the history for any particular instance by clicking the arrow next to that instance’s address:</p>
<p><img alt="Getting detail" src="http://i.stack.imgur.com/53Lou.gif"></p>
<p>In the detail view for an object, I can see the malloc and free events and, since I turned on “Record reference counts”, I can also see the retain, release, and autorelease messages and their effect on the object’s retain count. If I want to see the call stack for any of those events, I can open the extended detail panel on the right side of the window:</p>
<p><img alt="extended detail of call stack" src="http://i.stack.imgur.com/KKrT1.gif"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar/avatar.jpg"
               alt="姜楠" />
          <p class="site-author-name" itemprop="name">姜楠</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">115</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/njiang1987" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">姜楠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"njiang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
